<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>R.P.E - RÃ©vÃ©lateur des Potentiels et des Ã‰volutions</title>
  
  <!-- SDKs (Mocked if not present for standalone testing) -->
  <script>
    // Pre-initialize SDK mocks to avoid console errors
    window.elementSdkMissing = false;
    window.dataSdkMissing = false;
    
    // Initialize mock SDKs immediately
    if (typeof window.dataSdk === 'undefined') {
        window.dataSdk = {
            init: async () => {
                console.log('R.P.E: Using mock data SDK');
                return { isOk: true };
            },
            create: async (data) => {
                console.log('R.P.E: Data saved (mock):', data);
                return { isOk: true };
            }
        };
        window.dataSdkMissing = true;
    }
    
    if (typeof window.elementSdk === 'undefined') {
        window.elementSdk = {
            init: (config) => {
                console.log('R.P.E: Element SDK initialized (mock)', config);
            }
        };
        window.elementSdkMissing = true;
    }
  </script>
  <script src="/_sdk/element_sdk.js" onerror="console.log('R.P.E: Element SDK not loaded, using mock')"></script>
  <script src="/_sdk/data_sdk.js" onerror="console.log('R.P.E: Data SDK not loaded, using mock')"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #8A2BE2;
      --secondary: #FF007F;
      --accent: #D32F2F;
      --bg-gradient: linear-gradient(135deg, #FFF6F8 0%, #FFFFFF 100%);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      color: #2D3748;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    h1, h2, h3, .font-display {
      font-family: 'Poppins', sans-serif;
    }

    /* Background blobs */
    .blob {
      position: fixed;
      filter: blur(60px);
      z-index: 0;
      opacity: 0.4;
      animation: float 12s infinite ease-in-out;
    }
    .blob-1 { top: -10%; right: -10%; width: 400px; height: 400px; background: linear-gradient(135deg, #8A2BE2, #FF007F); animation-delay: 0s; }
    .blob-2 { bottom: -10%; left: -10%; width: 350px; height: 350px; background: #D32F2F; animation-delay: 3s; }

    @keyframes float {
      0% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -40px) scale(1.1); }
      66% { transform: translate(-20px, 30px) scale(0.9); }
      100% { transform: translate(0, 0) scale(1); }
    }

    /* Card & Interface */
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
    }

    /* Progress Bar */
    .progress-container {
      background: #EDF2F7;
      border-radius: 999px;
      overflow: hidden;
      height: 18px;
      position: relative;
    }
    .progress-fill {
      background: linear-gradient(90deg, #8A2BE2, #FF007F);
      height: 100%;
      border-radius: 999px;
      transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.3) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0.3) 75%,
        transparent 75%,
        transparent
      );
      background-size: 20px 20px;
      animation: moveStripe 1s linear infinite;
    }
    @keyframes moveStripe {
      0% { background-position: 0 0; }
      100% { background-position: 20px 20px; }
    }

    /* Option Buttons */
    .option-card {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      transform-origin: center;
      cursor: pointer;
    }
    .option-card:active {
      transform: scale(0.97);
    }
    .option-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(138, 43, 226, 0.15);
      border-color: #E2E8F0;
    }
    .option-card.selected {
      background: linear-gradient(135deg, #F3E8FF 0%, #FCE7F3 100%);
      border-color: #8A2BE2;
      box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.2);
    }
    
    /* Animations */
    .slide-in-right { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Level Up Overlay */
    .level-up-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.98);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .level-up-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Mobile specific adjustments */
    @media (max-width: 640px) {
      .option-card {
        padding: 1rem;
      }
      .question-text {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative">

  <!-- Background Elements -->
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <!-- Main App Container -->
  <div class="w-full max-w-3xl relative z-10">
    
    <!-- Header / Logo Area -->
    <div class="text-center mb-6 fade-in">
      <div class="inline-block bg-white p-3 rounded-full shadow-md mb-3">
        <div class="h-12 w-12 bg-gradient-to-br from-purple-600 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-2xl">
          RPE
        </div>
      </div>
      <h1 class="text-2xl font-bold mb-1" style="background: linear-gradient(90deg, #8A2BE2, #FF007F); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">R.P.E</h1>
      <p class="text-sm text-gray-600 font-medium">RÃ©vÃ©lateur des Potentiels et des Ã‰volutions</p>
    </div>

    <!-- Main Card -->
    <div class="glass-panel rounded-3xl p-6 md:p-10 shadow-2xl relative overflow-hidden min-h-[500px] flex flex-col transition-all duration-300" id="mainCard">
      
      <!-- WELCOME SCREEN -->
      <div id="welcomeScreen" class="flex flex-col items-center justify-center h-full text-center space-y-8 py-8 fade-in">
        <div class="text-6xl animate-bounce">ğŸ‘‹</div>
        <div class="space-y-4">
          <h1 id="welcomeTitle" class="text-3xl md:text-4xl font-extrabold font-display leading-tight" style="background: linear-gradient(90deg, #8A2BE2, #FF007F); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            PrÃªt Ã  dÃ©couvrir<br>tes potentiels ?
          </h1>
          <p class="text-gray-600 text-lg max-w-md mx-auto leading-relaxed">
            Pas de jugement, juste 5 minutes pour faire le point sur ta situation et rÃ©vÃ©ler tes potentiels !
          </p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm mt-4">
            <div class="p-4 rounded-2xl text-sm font-bold shadow-md" style="background: linear-gradient(135deg, #EBF4FF 0%, #E0E7FF 100%); color: #8A2BE2; border: 2px solid #8A2BE2;">ğŸ¯ 50 Questions</div>
            <div class="p-4 rounded-2xl text-sm font-bold shadow-md" style="background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E8 100%); color: #FF007F; border: 2px solid #FF007F;">ğŸ† 5 Niveaux</div>
        </div>

        <button id="startBtn" class="font-bold text-xl py-4 px-10 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 w-full max-w-xs mt-4 text-white" style="background: linear-gradient(90deg, #8A2BE2, #FF007F);">
          C'est parti ! ğŸš€
        </button>
      </div>

      <!-- QUIZ SCREEN -->
      <div id="quizScreen" class="hidden flex flex-col h-full">
        <!-- Progress Header -->
        <div class="mb-8">
          <div class="flex justify-between items-end mb-2">
            <span class="text-sm font-bold uppercase tracking-wider" id="levelIndicator" style="color: #8A2BE2;">Niveau 1/5</span>
            <span class="text-xs font-semibold text-gray-400" id="progressText">0%</span>
          </div>
          <div class="progress-container shadow-inner">
            <div id="progressFill" class="progress-fill w-0"></div>
          </div>
        </div>

        <!-- Question Area -->
        <div class="flex-grow flex flex-col justify-center">
          <div id="questionContainer" class="slide-in-right">
            <div class="inline-block px-4 py-2 rounded-full text-xs font-bold mb-4 shadow-sm" style="background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E8 100%); color: #FF007F;">
              Question <span id="qIndex">1</span>/50
            </div>
            <h2 id="questionText" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 font-display leading-snug">
              <!-- Question Text Here -->
            </h2>
            
            <div id="optionsGrid" class="grid grid-cols-1 gap-3">
              <!-- Options injected here -->
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <div class="mt-8 flex justify-between items-center pt-4 border-t border-gray-100">
          <button id="prevBtn" class="text-gray-400 hover:text-gray-600 font-semibold text-sm py-2 px-4 transition-colors hidden">
            â† Retour
          </button>
          <div class="flex-grow"></div>
        </div>

        <!-- Level Up Overlay -->
        <div id="levelUpOverlay" class="level-up-overlay rounded-3xl text-center p-8">
          <div class="text-6xl mb-4 animate-bounce">ğŸ‰</div>
          <h2 class="text-3xl font-bold mb-2 font-display" style="color: #8A2BE2;">Niveau ValidÃ© !</h2>
          <p class="text-gray-600 text-lg mb-6" id="levelUpMsg">Continue comme Ã§a, tu gÃ¨res !</p>
          <button id="nextLevelBtn" class="font-bold py-3 px-8 rounded-full shadow-md transition-colors text-white" style="background: linear-gradient(90deg, #8A2BE2, #FF007F);">
            Niveau Suivant â†’
          </button>
        </div>
      </div>

      <!-- LOADING SCREEN -->
      <div id="loadingScreen" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center rounded-3xl">
        <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
        <p class="text-lg font-semibold text-gray-600 animate-pulse">Analyse de tes potentiels...</p>
      </div>

      <!-- RESULTS SCREEN -->
      <div id="resultsScreen" class="hidden fade-in">
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">ğŸ†</div>
            <h2 id="profileTitle" class="text-3xl font-bold text-gray-800 font-display mb-2">Ton Profil</h2>
            <p id="profileSubtitle" class="text-xl font-medium" style="color: #8A2BE2;"></p>
        </div>

        <!-- Results Scrollable Area -->
        <div id="resultsContent" class="space-y-6 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
            <!-- Dynamic Content -->
        </div>

        <div class="mt-6 pt-6 border-t border-gray-100">
            <button id="restartBtn" class="w-full bg-gray-100 text-gray-600 font-bold py-4 rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                <span>ğŸ”„</span> Recommencer le test
            </button>
        </div>
      </div>

    </div>
    
    <!-- Footer -->
    <div class="text-center mt-6 text-xs text-gray-400">
      <p>R.P.E - RÃ©vÃ©lateur des Potentiels et des Ã‰volutions â€¢ Mission Locale</p>
    </div>
  </div>

  <!-- Confetti Canvas -->
  <canvas id="confettiCanvas" class="fixed inset-0 pointer-events-none z-50"></canvas>

  <script>
    // --- SDK INITIALIZATION (Enhanced) ---
    // SDKs are already mocked in the head section if not available
    
    // Ensure SDKs are properly initialized
    function ensureSDKs() {
        if (typeof window.dataSdk === 'undefined' || window.dataSdkMissing) {
            window.dataSdk = {
                init: async () => {
                    console.log('R.P.E: Data SDK initialized (standalone mode)');
                    return { isOk: true };
                },
                create: async (data) => {
                    console.log('R.P.E: Response data:', {
                        sessionId: data.id,
                        timestamp: data.timestamp,
                        totalQuestions: 50,
                        completed: true
                    });
                    // Store in localStorage as backup
                    try {
                        const stored = JSON.parse(localStorage.getItem('rpe_responses') || '[]');
                        stored.push(data);
                        localStorage.setItem('rpe_responses', JSON.stringify(stored));
                    } catch (e) {
                        console.warn('R.P.E: Could not store in localStorage', e);
                    }
                    return { isOk: true };
                }
            };
        }
        
        if (typeof window.elementSdk === 'undefined' || window.elementSdkMissing) {
            window.elementSdk = {
                init: (config) => {
                    console.log('R.P.E: Element SDK configured (standalone mode)', config);
                    // Apply default config if provided
                    if (config && config.defaultConfig) {
                        const defaultConfig = config.defaultConfig;
                        if (config.onConfigChange) {
                            config.onConfigChange(defaultConfig);
                        }
                    }
                }
            };
        }
    }

    // Call immediately
    ensureSDKs();

    // --- APP DATA ---
    console.log(`
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   R.P.E - RÃ©vÃ©lateur des Potentiels  â•‘
    â•‘        et des Ã‰volutions              â•‘
    â•‘                                       â•‘
    â•‘   Mission Locale Pays Basque          â•‘
    â•‘   Version: 1.0.0                      â•‘
    â•‘   Status: Ready âœ“                     â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `);

    // --- APP DATA ---
    const questions = [
      // NIVEAU 1 : Ã‰TAT D'ESPRIT
      { id: 1, text: "Comment te sens-tu en ce moment dans ta vie ?", emoji: "ğŸ’­", options: [{ emoji: "ğŸ˜Š", text: "PlutÃ´t bien, je suis sereinÂ·e", value: "good" }, { emoji: "ğŸ˜", text: "Ã‡a va, ni bien ni mal", value: "okay" }, { emoji: "ğŸ˜•", text: "Un peu perduÂ·e ou stressÃ©Â·e", value: "lost" }, { emoji: "ğŸ˜”", text: "Pas trÃ¨s bien en ce moment", value: "difficult" }] },
      { id: 2, text: "Qu'est-ce qui te prÃ©occupe le plus actuellement ?", emoji: "ğŸ¤”", options: [{ emoji: "ğŸ’°", text: "Ma situation financiÃ¨re", value: "money" }, { emoji: "ğŸ¯", text: "Mon avenir professionnel", value: "future" }, { emoji: "ğŸ ", text: "Mon logement / famille", value: "housing" }, { emoji: "ğŸ’š", text: "Ma santÃ© / bien-Ãªtre", value: "health" }, { emoji: "âœ¨", text: "Rien de particulier", value: "nothing" }] },
      { id: 3, text: "Arrives-tu Ã  te lever le matin avec un but ?", emoji: "ğŸŒ…", options: [{ emoji: "âœ…", text: "Oui, j'ai des choses prÃ©vues", value: "yes_planned" }, { emoji: "ğŸ¤·", text: "Parfois, Ã§a dÃ©pend", value: "sometimes" }, { emoji: "ğŸ˜´", text: "Non, routine monotone", value: "no_routine" }, { emoji: "ğŸ˜", text: "C'est dur de me lever", value: "difficult" }] },
      { id: 4, text: "As-tu des personnes sur qui compter ?", emoji: "ğŸ‘¥", options: [{ emoji: "â¤ï¸", text: "Oui, soutien proche", value: "strong_support" }, { emoji: "ğŸ‘", text: "Oui, quelques personnes", value: "some_support" }, { emoji: "ğŸ¤·", text: "Pas vraiment", value: "little_support" }, { emoji: "ğŸ˜”", text: "Non, je me sens isolÃ©Â·e", value: "isolated" }] },
      { id: 5, text: "Rencontrer de nouvelles personnes, c'est...", emoji: "ğŸ¤", options: [{ emoji: "ğŸ˜Š", text: "Facile, j'aime Ã§a", value: "comfortable" }, { emoji: "ğŸ˜", text: "Ã‡a dÃ©pend du moment", value: "depends" }, { emoji: "ğŸ˜°", text: "Stressant ou timide", value: "stressed" }, { emoji: "ğŸ˜¨", text: "Angoissant, j'Ã©vite", value: "anxious" }] },
      { id: 6, text: "Fais-tu des activitÃ©s rÃ©guliÃ¨res (sport, loisirs) ?", emoji: "âš½", options: [{ emoji: "âœ…", text: "Oui, rÃ©guliÃ¨rement", value: "regular" }, { emoji: "ğŸ‘", text: "De temps en temps", value: "occasional" }, { emoji: "ğŸ“º", text: "Rarement", value: "rarely" }, { emoji: "ğŸ›‹ï¸", text: "Non, pas du tout", value: "nothing" }] },
      { id: 7, text: "Comment gÃ¨res-tu ton budget ?", emoji: "ğŸ’³", options: [{ emoji: "âœ…", text: "Je gÃ¨re bien", value: "manage_well" }, { emoji: "ğŸ˜…", text: "C'est serrÃ© mais Ã§a va", value: "manage_tight" }, { emoji: "ğŸ˜°", text: "C'est difficile, je galÃ¨re", value: "struggle" }, { emoji: "ğŸš«", text: "Pas de revenus", value: "no_income" }] },
      { id: 8, text: "As-tu un endroit stable oÃ¹ dormir ?", emoji: "ğŸ¡", options: [{ emoji: "ğŸ ", text: "Oui (famille/parents)", value: "family" }, { emoji: "ğŸ”‘", text: "Oui, mon logement", value: "own_place" }, { emoji: "ğŸ¤", text: "HÃ©bergÃ©Â·e par ami(e)s", value: "friend" }, { emoji: "ğŸ˜”", text: "Non, c'est instable", value: "unstable" }] },
      { id: 9, text: "Ton niveau d'Ã©nergie au quotidien ?", emoji: "ğŸ”‹", options: [{ emoji: "âš¡", text: "J'ai la pÃªche !", value: "energetic" }, { emoji: "ğŸ˜", text: "Ã‡a va, variable", value: "variable" }, { emoji: "ğŸ˜´", text: "Souvent fatiguÃ©Â·e", value: "tired" }, { emoji: "ğŸ˜", text: "Ã‰puisÃ©Â·e", value: "exhausted" }] },
      { id: 10, text: "Qu'est-ce qui te motive le plus ?", emoji: "âœ¨", options: [{ emoji: "ğŸ‘¥", text: "Voir des gens", value: "social" }, { emoji: "ğŸ¨", text: "CrÃ©er des choses", value: "creative" }, { emoji: "ğŸ¯", text: "RÃ©ussir mes objectifs", value: "goals" }, { emoji: "ğŸ˜”", text: "Je ne sais pas trop", value: "unsure" }] },
      
      // NIVEAU 2 : COMPÃ‰TENCES
      { id: 11, text: "Ton expÃ©rience du travail ?", emoji: "ğŸ’¼", options: [{ emoji: "âœ…", text: "Plusieurs expÃ©riences", value: "multiple" }, { emoji: "ğŸ‘", text: "Quelques petits boulots", value: "some" }, { emoji: "ğŸŒ±", text: "Juste des stages", value: "internship" }, { emoji: "âŒ", text: "Aucune pour l'instant", value: "never" }] },
      { id: 12, text: "Ta plus grande peur au travail ?", emoji: "ğŸ˜°", options: [{ emoji: "ğŸ‘¥", text: "Les collÃ¨gues / relations", value: "people" }, { emoji: "â°", text: "Les horaires / rythme", value: "schedule" }, { emoji: "ğŸ¤¯", text: "Ne pas y arriver", value: "competence" }, { emoji: "ğŸ˜Š", text: "Aucune peur spÃ©ciale", value: "nothing" }] },
      { id: 13, text: "Le frein principal pour travailler ?", emoji: "ğŸš§", options: [{ emoji: "ğŸ¥", text: "SantÃ©", value: "health" }, { emoji: "ğŸš—", text: "Transport", value: "transport" }, { emoji: "ğŸ˜”", text: "Confiance en soi", value: "confidence" }, { emoji: "â“", text: "Je suis perduÂ·e", value: "lost" }, { emoji: "âœ…", text: "Aucun frein", value: "nothing" }] },
      { id: 14, text: "As-tu une idÃ©e de mÃ©tier ?", emoji: "ğŸ’¡", options: [{ emoji: "âœ¨", text: "Oui, idÃ©e prÃ©cise", value: "clear" }, { emoji: "ğŸ¤”", text: "Quelques pistes", value: "ideas" }, { emoji: "ğŸ—ºï¸", text: "Je cherche encore", value: "searching" }, { emoji: "â“", text: "Aucune idÃ©e", value: "no_idea" }] },
      { id: 15, text: "PrÃªtÂ·e pour une formation ?", emoji: "ğŸ“š", options: [{ emoji: "ğŸš€", text: "Oui, motivÃ©Â·e !", value: "motivated" }, { emoji: "ğŸ¤·", text: "Peut-Ãªtre", value: "maybe" }, { emoji: "ğŸ˜•", text: "Peur que ce soit dur", value: "afraid" }, { emoji: "âŒ", text: "Pas pour le moment", value: "not_now" }] },
      { id: 16, text: "Ã€ l'aise avec le numÃ©rique ?", emoji: "ğŸ’»", options: [{ emoji: "ğŸ˜Š", text: "Oui, je gÃ¨re", value: "comfortable" }, { emoji: "ğŸ“±", text: "Juste sur tÃ©lÃ©phone", value: "phone_only" }, { emoji: "ğŸ˜•", text: "Pas trÃ¨s Ã  l'aise", value: "uncomfortable" }, { emoji: "âŒ", text: "Pas d'accÃ¨s facile", value: "no_access" }] },
      { id: 17, text: "Ta capacitÃ© de concentration ?", emoji: "ğŸ¯", options: [{ emoji: "âœ…", text: "Bonne", value: "yes" }, { emoji: "ğŸ˜", text: "Ã‡a dÃ©pend du sujet", value: "depends" }, { emoji: "ğŸ˜°", text: "Difficile", value: "difficult" }, { emoji: "ğŸ¤¯", text: "TrÃ¨s difficile", value: "very_difficult" }] },
      { id: 18, text: "Face Ã  un problÃ¨me, tu...", emoji: "ğŸ§©", options: [{ emoji: "ğŸ’ª", text: "Cherches une solution", value: "solve" }, { emoji: "ğŸ¤", text: "Demandes de l'aide", value: "ask_help" }, { emoji: "ğŸ˜", text: "Te dÃ©courages", value: "discouraged" }, { emoji: "ğŸ™ˆ", text: "L'Ã©vites", value: "avoid" }] },
      { id: 19, text: "Te fixes-tu des objectifs ?", emoji: "ğŸ“ˆ", options: [{ emoji: "âœ…", text: "Oui, souvent", value: "often" }, { emoji: "ğŸ‘", text: "Parfois", value: "sometimes" }, { emoji: "ğŸ˜•", text: "Rarement", value: "rarely" }, { emoji: "âŒ", text: "Jamais", value: "never" }] },
      { id: 20, text: "Ta forme physique ?", emoji: "ğŸƒ", options: [{ emoji: "ğŸ’ª", text: "En forme", value: "good" }, { emoji: "ğŸ˜", text: "Ã‡a va", value: "okay" }, { emoji: "ğŸ˜´", text: "FatiguÃ©Â·e", value: "tired" }, { emoji: "ğŸ¥", text: "ProblÃ¨mes de santÃ©", value: "health_issues" }] },

      // NIVEAU 3 : SANTÃ‰ & MODE DE VIE
      { id: 21, text: "Ton sommeil ?", emoji: "ğŸ˜´", options: [{ emoji: "âœ…", text: "Je dors bien", value: "well" }, { emoji: "ğŸ˜", text: "Variable", value: "variable" }, { emoji: "ğŸ˜°", text: "Difficile", value: "difficulty" }, { emoji: "ğŸŒ™", text: "DÃ©calÃ© (nuit/jour)", value: "reversed" }] },
      { id: 22, text: "Ton alimentation ?", emoji: "ğŸ½ï¸", options: [{ emoji: "âœ…", text: "Bien, Ã  ma faim", value: "yes" }, { emoji: "ğŸ˜", text: "Pas trÃ¨s Ã©quilibrÃ©", value: "unbalanced" }, { emoji: "ğŸ˜•", text: "Parfois c'est juste", value: "sometimes" }, { emoji: "ğŸ˜”", text: "Pas assez", value: "no" }] },
      { id: 23, text: "Suivi psychologique ?", emoji: "ğŸ§ ", options: [{ emoji: "âœ…", text: "Oui, Ã§a aide", value: "yes_helpful" }, { emoji: "ğŸ¤·", text: "J'ai arrÃªtÃ©", value: "yes_stopped" }, { emoji: "âŒ", text: "Jamais", value: "never" }, { emoji: "ğŸ¤”", text: "J'aimerais bien", value: "interested" }] },
      { id: 24, text: "Moments de tristesse/anxiÃ©tÃ© ?", emoji: "ğŸ’™", options: [{ emoji: "âŒ", text: "Rarement", value: "rarely" }, { emoji: "ğŸ˜", text: "Parfois", value: "sometimes" }, { emoji: "ğŸ˜”", text: "Souvent", value: "often" }, { emoji: "ğŸ˜", text: "Tout le temps", value: "always" }] },
      { id: 25, text: "Permis de conduire ?", emoji: "ğŸš—", options: [{ emoji: "âœ…", text: "Oui + vÃ©hicule", value: "yes_vehicle" }, { emoji: "ğŸ”‘", text: "Oui, sans vÃ©hicule", value: "yes_no_vehicle" }, { emoji: "ğŸ“š", text: "En cours", value: "in_progress" }, { emoji: "âŒ", text: "Non", value: "no" }] },
      { id: 26, text: "Tes dÃ©placements ?", emoji: "ğŸš¶", options: [{ emoji: "ğŸš—", text: "Voiture", value: "car" }, { emoji: "ğŸšŒ", text: "Transports en commun", value: "public" }, { emoji: "ğŸš´", text: "VÃ©lo / Pied", value: "bike_walk" }, { emoji: "ğŸ˜”", text: "CompliquÃ©", value: "difficult" }] },
      { id: 27, text: "Sans ton tÃ©lÃ©phone, tu tiens...", emoji: "ğŸ“±", options: [{ emoji: "âœ…", text: "Des heures", value: "hours" }, { emoji: "ğŸ˜", text: "1 heure max", value: "one_hour" }, { emoji: "ğŸ˜…", text: "30 minutes", value: "thirty_min" }, { emoji: "ğŸ¤³", text: "Impossible", value: "few_minutes" }] },
      { id: 28, text: "Temps sur les Ã©crans/jeux ?", emoji: "ğŸ®", options: [{ emoji: "âŒ", text: "TrÃ¨s peu", value: "little" }, { emoji: "ğŸ˜", text: "Raisonnable", value: "moderate" }, { emoji: "ğŸ˜…", text: "Beaucoup", value: "much" }, { emoji: "ğŸ¤¯", text: "Excessif", value: "excessive" }] },
      { id: 29, text: "Alcool / Tabac / Autres ?", emoji: "ğŸš¬", options: [{ emoji: "âŒ", text: "Non", value: "no" }, { emoji: "ğŸ˜", text: "Occasionnel", value: "occasional" }, { emoji: "ğŸ˜•", text: "Difficile Ã  gÃ©rer", value: "difficulty" }, { emoji: "ğŸ¤", text: "Je passe", value: "no_answer" }] },
      { id: 30, text: "ProblÃ¨mes avec la justice ?", emoji: "âš–ï¸", options: [{ emoji: "âœ…", text: "Non", value: "no" }, { emoji: "ğŸ“…", text: "Par le passÃ©", value: "past" }, { emoji: "âš ï¸", text: "En cours", value: "current" }, { emoji: "ğŸ¤", text: "Je passe", value: "no_answer" }] },

      // NIVEAU 4 : SAVOIRS & AUTONOMIE
      { id: 31, text: "Lire et Ã©crire ?", emoji: "ğŸ“–", options: [{ emoji: "âœ…", text: "Facile", value: "fluent" }, { emoji: "ğŸ˜", text: "Quelques difficultÃ©s", value: "some_difficulty" }, { emoji: "ğŸ˜•", text: "Difficile", value: "difficult" }, { emoji: "âŒ", text: "TrÃ¨s difficile", value: "very_difficult" }] },
      { id: 32, text: "Calculer ?", emoji: "ğŸ”¢", options: [{ emoji: "âœ…", text: "Facile", value: "easy" }, { emoji: "ğŸ˜", text: "Besoin de temps", value: "with_time" }, { emoji: "ğŸ˜•", text: "CompliquÃ©", value: "difficult" }, { emoji: "âŒ", text: "TrÃ¨s difficile", value: "very_difficult" }] },
      { id: 33, text: "Parcours scolaire ?", emoji: "ğŸ“", options: [{ emoji: "ğŸ“š", text: "CollÃ¨ge", value: "middle_school" }, { emoji: "ğŸ’", text: "CAP / BEP", value: "vocational" }, { emoji: "ğŸ“–", text: "Bac", value: "high_school" }, { emoji: "ğŸ¯", text: "Ã‰tudes supÃ©rieures", value: "higher_ed" }] },
      { id: 34, text: "L'Ã©cole, c'Ã©tait comment ?", emoji: "ğŸ«", options: [{ emoji: "ğŸ˜Š", text: "PlutÃ´t bien", value: "good" }, { emoji: "ğŸ˜", text: "Moyen", value: "okay" }, { emoji: "ğŸ˜•", text: "Difficile", value: "difficult" }, { emoji: "ğŸ˜", text: "Un cauchemar", value: "very_difficult" }] },
      { id: 35, text: "Reprendre une formation ?", emoji: "ğŸ’", options: [{ emoji: "âœ¨", text: "Oui, vite !", value: "yes_soon" }, { emoji: "ğŸ¤”", text: "Plus tard", value: "yes_later" }, { emoji: "ğŸ¤·", text: "Je ne sais pas", value: "unsure" }, { emoji: "âŒ", text: "Non merci", value: "no" }] },
      { id: 36, text: "Papiers administratifs ?", emoji: "ğŸ“", options: [{ emoji: "âœ…", text: "Je gÃ¨re", value: "confident" }, { emoji: "ğŸ˜", text: "Avec de l'aide", value: "with_help" }, { emoji: "ğŸ˜°", text: "Stressant", value: "stressed" }, { emoji: "ğŸš«", text: "Je bloque", value: "blocked" }] },
      { id: 37, text: "Sais-tu oÃ¹ trouver de l'aide ?", emoji: "ğŸ—ºï¸", options: [{ emoji: "âœ…", text: "Oui (ML, PÃ´le Emploi...)", value: "know" }, { emoji: "ğŸ¤·", text: "Vaguement", value: "heard" }, { emoji: "â“", text: "Non", value: "dont_know" }, { emoji: "ğŸ˜•", text: "J'ose pas y aller", value: "afraid" }] },
      { id: 38, text: "AnciennetÃ© Mission Locale ?", emoji: "â³", options: [{ emoji: "ğŸ†•", text: "< 3 mois", value: "new" }, { emoji: "ğŸ“…", text: "3-6 mois", value: "recent" }, { emoji: "ğŸ“†", text: "6 mois - 1 an", value: "established" }, { emoji: "ğŸ¦–", text: "> 1 an", value: "long_term" }] },
      { id: 39, text: "Attente de l'accompagnement ?", emoji: "ğŸ¯", options: [{ emoji: "ğŸ’¼", text: "Un emploi", value: "job" }, { emoji: "ğŸ“š", text: "Une formation", value: "training" }, { emoji: "ğŸ’¡", text: "Mon projet", value: "discovery" }, { emoji: "ğŸ¤", text: "Du soutien", value: "support" }] },
      { id: 40, text: "Dans 6 mois, tu es oÃ¹ ?", emoji: "ğŸ”®", options: [{ emoji: "ğŸ’¼", text: "En emploi", value: "employed" }, { emoji: "ğŸ“š", text: "En formation", value: "training" }, { emoji: "ğŸŒ±", text: "En test", value: "trying" }, { emoji: "ğŸ¤·", text: "Je ne sais pas", value: "no_idea" }] },

      // NIVEAU 5 : PROJECTION
      { id: 41, text: "Motivation du matin ?", emoji: "â˜€ï¸", options: [{ emoji: "ğŸ’°", text: "L'argent", value: "money" }, { emoji: "ğŸ‘¥", text: "Le social", value: "social" }, { emoji: "ğŸ¯", text: "Un projet", value: "purpose" }, { emoji: "ğŸ˜”", text: "Rien", value: "unsure" }] },
      { id: 42, text: "ActivitÃ© gratuite demain ?", emoji: "ğŸ«", options: [{ emoji: "âœ¨", text: "Go !", value: "yes_eager" }, { emoji: "ğŸ¤”", text: "Ã‡a dÃ©pend", value: "depends" }, { emoji: "ğŸ¤·", text: "Peut-Ãªtre", value: "maybe" }, { emoji: "âŒ", text: "Non", value: "no" }] },
      { id: 43, text: "Travail seul ou Ã©quipe ?", emoji: "ğŸ‘¥", options: [{ emoji: "ğŸ‘¥", text: "Ã‰quipe", value: "team" }, { emoji: "ğŸ¤", text: "Les deux", value: "both" }, { emoji: "ğŸ‘¤", text: "SeulÂ·e", value: "alone" }, { emoji: "ğŸ¤·", text: "Sais pas", value: "unsure" }] },
      { id: 44, text: "Le plus important au travail ?", emoji: "ğŸ’", options: [{ emoji: "ğŸ’°", text: "Salaire", value: "salary" }, { emoji: "ğŸ–ï¸", text: "Horaires/Vie perso", value: "balance" }, { emoji: "â¤ï¸", text: "Ambiance", value: "atmosphere" }, { emoji: "âœ¨", text: "Le sens", value: "meaning" }] },
      { id: 45, text: "Confiance en toi ?", emoji: "ğŸ¦", options: [{ emoji: "âœ¨", text: "Oui !", value: "confident" }, { emoji: "ğŸ¤·", text: "Variable", value: "sometimes" }, { emoji: "ğŸ˜•", text: "Pas trop", value: "low" }, { emoji: "ğŸ˜", text: "Pas du tout", value: "very_low" }] },
      { id: 46, text: "Qu'est-ce qui te ferait plaisir ?", emoji: "ğŸ", options: [{ emoji: "ğŸ’°", text: "Argent", value: "money" }, { emoji: "ğŸ‘¥", text: "Amis/Famille", value: "social" }, { emoji: "ğŸ¯", text: "Projet concret", value: "project" }, { emoji: "ğŸ˜Œ", text: "ÃŠtre zen", value: "wellbeing" }] },
      { id: 47, text: "Ta situation en un mot ?", emoji: "ğŸ·ï¸", options: [{ emoji: "ğŸ˜Š", text: "Transition", value: "transition" }, { emoji: "ğŸ˜”", text: "BloquÃ©Â·e", value: "stuck" }, { emoji: "ğŸ¤”", text: "PerduÂ·e", value: "lost" }, { emoji: "âœ¨", text: "Espoir", value: "hopeful" }] },
      { id: 48, text: "Te sens-tu jugÃ©Â·e ?", emoji: "ğŸ‘€", options: [{ emoji: "âŒ", text: "Non", value: "no" }, { emoji: "ğŸ¤·", text: "Parfois", value: "sometimes" }, { emoji: "ğŸ˜”", text: "Souvent", value: "often" }, { emoji: "ğŸ˜", text: "Toujours", value: "always" }] },
      { id: 49, text: "Un coup de baguette magique ?", emoji: "ğŸª„", options: [{ emoji: "ğŸ’¼", text: "Job de rÃªve", value: "job" }, { emoji: "â¤ï¸", text: "Bien-Ãªtre", value: "wellbeing" }, { emoji: "ğŸ’°", text: "Richesse", value: "money" }, { emoji: "ğŸ ", text: "StabilitÃ©", value: "stability" }] },
      { id: 50, text: "PrÃªtÂ·e Ã  avancer ?", emoji: "ğŸš€", options: [{ emoji: "âœ¨", text: "Oui !", value: "ready" }, { emoji: "ğŸ¤”", text: "Avec de l'aide", value: "with_support" }, { emoji: "ğŸ˜•", text: "Je ne sais pas", value: "unsure" }, { emoji: "âŒ", text: "Pas encore", value: "not_now" }] }
    ];

    // LEVEL CONFIGURATION
    const LEVEL_SIZE = 10;
    const LEVEL_MESSAGES = [
        "C'est un excellent dÃ©but ! On commence Ã  mieux cerner ton Ã©tat d'esprit.",
        "Super ! Tes compÃ©tences et ton passÃ© se dessinent.",
        "Parfait ! Ton bien-Ãªtre est essentiel pour la suite.",
        "Tu avances bien ! L'autonomie est une clÃ© importante.",
        "DerniÃ¨re ligne droite ! Regardons vers l'avenir."
    ];

    // STATE
    let currentStep = 0;
    let responses = {};
    let sessionId = null;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('R.P.E: Initializing application...');
        initializeApp();
    });

    async function initializeApp() {
        try {
            // Initialize data SDK
            const initResult = await window.dataSdk.init();
            console.log('R.P.E: Data SDK ready', initResult);
            
            // Initialize element SDK with safe config
            window.elementSdk.init({
                defaultConfig: { 
                    app_title: "R.P.E", 
                    welcome_title: "PrÃªt Ã  dÃ©couvrir tes potentiels ?", 
                    start_button: "C'est parti !" 
                },
                onConfigChange: (config) => {
                    try {
                        const welcomeTitle = document.getElementById('welcomeTitle');
                        const startBtn = document.getElementById('startBtn');
                        
                        if (welcomeTitle && config.welcome_title) {
                            welcomeTitle.innerHTML = config.welcome_title.replace(/\n/g, '<br>');
                        }
                        
                        if (startBtn && config.start_button) {
                            startBtn.textContent = config.start_button + " ğŸš€";
                        }
                    } catch (e) {
                        console.warn('R.P.E: Error applying config', e);
                    }
                }
            });

            // Attach event listeners with error handling
            const attachListener = (id, event, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                    console.log(`R.P.E: Attached ${event} listener to #${id}`);
                } else {
                    console.warn(`R.P.E: Element #${id} not found`);
                }
            };

            attachListener('startBtn', 'click', startQuiz);
            attachListener('prevBtn', 'click', previousQuestion);
            attachListener('nextLevelBtn', 'click', closeLevelOverlay);
            attachListener('restartBtn', 'click', restartQuiz);
            
            console.log('R.P.E: Application ready! ğŸš€');
            
        } catch (error) {
            console.error('R.P.E: Initialization error', error);
            // Try to display error to user
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.innerHTML += '<p style="color: #D32F2F; margin-top: 1rem; font-size: 0.9rem;">âš ï¸ Erreur d\'initialisation. Veuillez recharger la page.</p>';
            }
        }
    }

    // --- GAME LOGIC ---
    function startQuiz() {
        console.log('R.P.E: Starting quiz...');
        sessionId = 'session_' + Date.now();
        currentStep = 0;
        responses = {};
        
        console.log('R.P.E: Session ID:', sessionId);
        
        const welcomeScreen = document.getElementById('welcomeScreen');
        const quizScreen = document.getElementById('quizScreen');
        
        if (welcomeScreen) welcomeScreen.classList.add('hidden');
        if (quizScreen) quizScreen.classList.remove('hidden');
        
        showQuestion(currentStep);
    }

    function showQuestion(index) {
        try {
            const question = questions[index];
            const currentLevel = Math.floor(index / LEVEL_SIZE) + 1;
            
            console.log(`R.P.E: Question ${index + 1}/50 (Level ${currentLevel})`);
            
            const progress = ((index) / questions.length) * 100;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const levelIndicator = document.getElementById('levelIndicator');
            const qIndex = document.getElementById('qIndex');
            const questionText = document.getElementById('questionText');
            const optionsGrid = document.getElementById('optionsGrid');
            
            if (progressFill) progressFill.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `${Math.round(progress)}%`;
            if (levelIndicator) levelIndicator.textContent = `Niveau ${currentLevel}/5`;
            if (qIndex) qIndex.textContent = index + 1;

            const container = document.getElementById('questionContainer');
            if (container) {
                container.classList.remove('slide-in-right', 'slide-in-left');
                void container.offsetWidth;
                container.classList.add('slide-in-right');
            }

            if (questionText) {
                questionText.innerHTML = `${question.emoji} ${question.text}`;
            }
            
            if (optionsGrid) {
                optionsGrid.innerHTML = '';

                question.options.forEach((option, i) => {
                    const btn = document.createElement('div');
                    btn.className = `option-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4`;
                    btn.style.animationDelay = `${i * 50}ms`;
                    btn.classList.add('pop-in');
                    
                    if (responses[question.id] === option.value) {
                        btn.classList.add('selected');
                    }

                    btn.innerHTML = `
                        <span class="text-3xl filter drop-shadow-sm">${option.emoji}</span>
                        <span class="font-medium text-lg text-gray-700 flex-grow">${option.text}</span>
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center selection-circle" style="border-color: #8A2BE2;">
                            ${responses[question.id] === option.value ? '<div class="w-3 h-3 rounded-full" style="background: linear-gradient(90deg, #8A2BE2, #FF007F);"></div>' : ''}
                        </div>
                    `;
                    
                    btn.onclick = () => selectOption(question.id, option.value, btn);
                    optionsGrid.appendChild(btn);
                });
            }

            const prevBtn = document.getElementById('prevBtn');
            if (prevBtn) {
                prevBtn.style.visibility = index === 0 ? 'hidden' : 'visible';
            }
            
        } catch (error) {
            console.error('R.P.E: Error showing question', error);
        }
    }

    function selectOption(questionId, value, clickedBtn) {
        console.log(`R.P.E: Selected option for Q${questionId}:`, value);
        
        const optionsGrid = document.getElementById('optionsGrid');
        if (optionsGrid) {
            const allBtns = optionsGrid.children;
            for (let btn of allBtns) {
                btn.classList.remove('selected');
                const circle = btn.querySelector('.selection-circle');
                if (circle) circle.innerHTML = '';
            }
        }
        
        clickedBtn.classList.add('selected');
        const circle = clickedBtn.querySelector('.selection-circle');
        if (circle) {
            circle.innerHTML = '<div class="w-3 h-3 rounded-full" style="background: linear-gradient(90deg, #8A2BE2, #FF007F);"></div>';
        }

        responses[questionId] = value;

        setTimeout(() => nextQuestion(), 400);
    }

    function previousQuestion() {
        if (currentStep > 0) {
            console.log('R.P.E: Going back to previous question');
            currentStep--;
            showQuestion(currentStep);
        }
    }

    async function nextQuestion() {
        const nextStep = currentStep + 1;
        
        if (nextStep < questions.length && nextStep % LEVEL_SIZE === 0) {
            console.log(`R.P.E: Level ${Math.floor(nextStep / LEVEL_SIZE)} completed!`);
            showLevelUp(Math.floor(nextStep / LEVEL_SIZE));
            currentStep++;
        } else if (nextStep < questions.length) {
            currentStep++;
            showQuestion(currentStep);
        } else {
            console.log('R.P.E: All questions completed!');
            finishQuiz();
        }
    }

    function showLevelUp(levelCompleted) {
        console.log(`R.P.E: Showing level ${levelCompleted} completion`);
        
        const overlay = document.getElementById('levelUpOverlay');
        const msg = document.getElementById('levelUpMsg');
        
        if (msg) {
            msg.textContent = LEVEL_MESSAGES[levelCompleted - 1] || "Bravo !";
        }
        
        if (overlay) {
            overlay.classList.add('active');
        }
        
        fireConfetti();
    }

    function closeLevelOverlay() {
        console.log('R.P.E: Closing level overlay');
        
        const overlay = document.getElementById('levelUpOverlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
        
        showQuestion(currentStep);
    }

    async function finishQuiz() {
        console.log('R.P.E: Quiz completed, processing results...');
        
        document.getElementById('quizScreen').classList.add('hidden');
        document.getElementById('loadingScreen').classList.remove('hidden');
        document.getElementById('loadingScreen').classList.add('flex');

        setTimeout(async () => {
            try {
                // Save data with error handling
                const responseData = {
                    id: sessionId,
                    timestamp: new Date().toISOString(),
                    current_step: currentStep,
                    responses: JSON.stringify(responses)
                };
                
                const result = await window.dataSdk.create(responseData);
                
                if (result && result.isOk) {
                    console.log('R.P.E: Data saved successfully');
                } else {
                    console.warn('R.P.E: Data save returned unexpected result', result);
                }
                
            } catch (error) {
                console.error('R.P.E: Error saving data', error);
                // Continue anyway to show results
            }

            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('flex');
            showResults();
        }, 1500);
    }

    function showResults() {
        try {
            console.log('R.P.E: Analyzing profile...');
            const profile = analyzeProfile();
            console.log('R.P.E: Profile analysis complete', {
                title: profile.title,
                lifeSkillsCount: profile.lifeSkills.length,
                thematicSkillsCount: profile.thematicSkills.length,
                improvementsCount: profile.improvements.length,
                parcoursCount: profile.parcours.length
            });
            
            const resultsScreen = document.getElementById('resultsScreen');
            const profileTitle = document.getElementById('profileTitle');
            const profileSubtitle = document.getElementById('profileSubtitle');
            const content = document.getElementById('resultsContent');
            
            if (!resultsScreen || !profileTitle || !profileSubtitle || !content) {
                console.error('R.P.E: Missing results DOM elements');
                return;
            }
            
            resultsScreen.classList.remove('hidden');
            profileTitle.textContent = profile.title;
            profileSubtitle.textContent = profile.subtitle;

            fireConfetti(true);

            content.innerHTML = `
                ${renderSection('ğŸŒŸ Axes Fondamentaux', profile.lifeSkills, true)}
                ${renderSection('ğŸ¯ CompÃ©tences ThÃ©matiques', profile.thematicSkills)}
                ${renderStrengthsAndImprovements(profile.improvements)}
                ${renderParcours(profile.parcours)}
                ${renderContact()}
            `;
            
            console.log('R.P.E: Results displayed successfully');
            
        } catch (error) {
            console.error('R.P.E: Error showing results', error);
            
            // Display error message to user
            const resultsScreen = document.getElementById('resultsScreen');
            const content = document.getElementById('resultsContent');
            
            if (resultsScreen && content) {
                resultsScreen.classList.remove('hidden');
                document.getElementById('profileTitle').textContent = "Erreur";
                document.getElementById('profileSubtitle').textContent = "Un problÃ¨me est survenu";
                content.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-xl">
                        <p class="text-red-800">
                            <strong>âš ï¸ Erreur lors de l'affichage des rÃ©sultats</strong><br>
                            Veuillez rÃ©essayer ou contacter votre conseiller.
                        </p>
                    </div>
                `;
            }
        }
    }

    function renderSection(title, items, isLifeSkill = false) {
        return `
            <div class="bg-white rounded-2xl p-6 shadow-sm border-2" style="border-color: #E2E8F0;">
                <h3 class="text-xl font-bold text-gray-800 mb-4 font-display">${title}</h3>
                <div class="space-y-4">
                    ${items.map(item => `
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${item.emoji}</span>
                                    <span class="font-bold text-gray-700">${item.label}</span>
                                </div>
                                <span class="font-bold" style="color: #8A2BE2;">${item.value}/5</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="h-2.5 rounded-full" style="width: ${(item.value/5)*100}%; background: linear-gradient(90deg, #8A2BE2, #FF007F);"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${item.description}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderStrengthsAndImprovements(improvements) {
        return `
            <div class="rounded-2xl p-6 border-l-4" style="background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E8 100%); border-color: #FF007F;">
                <h3 class="text-lg font-bold mb-3" style="color: #D32F2F;">ğŸ’¡ Points Ã  explorer</h3>
                <div class="grid gap-3">
                    ${improvements.map(imp => `
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">${imp.emoji}</span>
                            <div>
                                <strong class="text-gray-800 block">${imp.title}</strong>
                                <span class="text-sm text-gray-600">${imp.description}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderParcours(parcours) {
        return `
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-gray-800 font-display px-2">ğŸš€ Tes recommandations</h3>
                ${parcours.map(p => `
                    <div class="bg-white p-5 rounded-2xl shadow-md border-2 border-transparent hover:scale-105 transition-all transform" style="border-color: transparent;">
                        <div class="flex items-start gap-4">
                            <div class="p-3 rounded-xl text-3xl" style="background: linear-gradient(135deg, #EBF4FF 0%, #E0E7FF 100%);">${p.emoji}</div>
                            <div class="flex-grow">
                                <h4 class="font-bold text-lg mb-1" style="color: #8A2BE2;">${p.title}</h4>
                                <p class="text-sm text-gray-600 mb-3 leading-relaxed">${p.description}</p>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${p.tags.map(t => `<span class="text-xs font-bold px-2 py-1 rounded-md" style="background: linear-gradient(135deg, #F3E8FF 0%, #FCE7F3 100%); color: #8A2BE2;">${t}</span>`).join('')}
                                </div>
                                <a href="${p.link}" target="_blank" class="inline-flex items-center text-sm font-bold hover:underline" style="color: #FF007F;">
                                    DÃ©couvrir ce parcours â†’
                                </a>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderContact() {
        return `
             <div class="text-white rounded-2xl p-6 text-center shadow-lg" style="background: linear-gradient(135deg, #8A2BE2, #FF007F);">
                <h3 class="text-xl font-bold mb-2">Besoin d'en parler ?</h3>
                <p class="mb-4 text-sm" style="color: rgba(255,255,255,0.9);">Tes conseillers sont lÃ  pour analyser ces rÃ©sultats avec toi.</p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <a href="https://mlpb-tools.github.io/MLS4YOU/" target="_blank" class="bg-white font-bold py-2 px-6 rounded-full hover:bg-gray-100 transition-colors" style="color: #8A2BE2;">
                        ğŸŒ Site Web
                    </a>
                    <a href="https://mlpb-tools.my.canva.site/mini-parcours-th-matiques" target="_blank" class="font-bold py-2 px-6 rounded-full transition-colors text-white" style="background: rgba(255,255,255,0.2);">
                        ğŸ“š Catalogue
                    </a>
                </div>
             </div>
        `;
    }

    function restartQuiz() {
        console.log('R.P.E: Restarting quiz...');
        
        const resultsScreen = document.getElementById('resultsScreen');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const progressFill = document.getElementById('progressFill');
        
        if (resultsScreen) resultsScreen.classList.add('hidden');
        if (welcomeScreen) welcomeScreen.classList.remove('hidden');
        if (progressFill) progressFill.style.width = '0%';
        
        sessionId = null;
        currentStep = 0;
        responses = {};
        
        console.log('R.P.E: Quiz reset complete');
    }

    function analyzeProfile() {
      const r = (id) => responses[id];

      // AXE 1: PERSONNALITÃ‰
      let personalityScore = 0;
      if (r(45) === 'confident') personalityScore += 3;
      else if (r(45) === 'sometimes') personalityScore += 2;
      else if (r(45) === 'low') personalityScore += 1;
      
      if (r(47) === 'hopeful') personalityScore += 2;
      else if (r(47) === 'transition') personalityScore += 1;
      
      if (r(48) === 'no') personalityScore += 2;
      else if (r(48) === 'sometimes') personalityScore += 1;
      
      if (['goals','creative','social'].includes(r(10))) personalityScore += 2;
      if (['purpose','social','money'].includes(r(41))) personalityScore += 2;
      
      if (r(50) === 'ready') personalityScore += 3;
      else if (r(50) === 'with_support') personalityScore += 2;
      else if (r(50) === 'unsure') personalityScore += 1;
      
      if (r(18) === 'solve') personalityScore += 2;
      else if (r(18) === 'ask_help') personalityScore += 1;
      
      if (r(19) === 'often') personalityScore += 2;
      else if (r(19) === 'sometimes') personalityScore += 1;
      
      if (r(24) === 'rarely') personalityScore += 2;
      else if (r(24) === 'sometimes') personalityScore += 1;

      // AXE 2: VALORISATION DE SOI
      let valorizationScore = 0;
      if (r(11) === 'multiple') valorizationScore += 3;
      else if (r(11) === 'some') valorizationScore += 2;
      else if (r(11) === 'internship') valorizationScore += 1;
      
      if (r(33) === 'higher_ed') valorizationScore += 3;
      else if (r(33) === 'high_school') valorizationScore += 2;
      else if (r(33) === 'vocational') valorizationScore += 1;
      
      if (r(34) === 'good') valorizationScore += 2;
      else if (r(34) === 'okay') valorizationScore += 1;
      
      if (r(16) === 'comfortable') valorizationScore += 2;
      else if (r(16) === 'phone_only') valorizationScore += 1;
      
      if (r(31) === 'fluent') valorizationScore += 2;
      else if (r(31) === 'some_difficulty') valorizationScore += 1;
      
      if (r(32) === 'easy') valorizationScore += 2;
      else if (r(32) === 'with_time') valorizationScore += 1;
      
      if (r(36) === 'confident') valorizationScore += 2;
      else if (r(36) === 'with_help') valorizationScore += 1;
      
      if (r(6) === 'regular') valorizationScore += 2;
      else if (r(6) === 'occasional') valorizationScore += 1;
      
      if (r(17) === 'yes') valorizationScore += 2;
      else if (r(17) === 'depends') valorizationScore += 1;
      
      if (r(42) === 'yes_eager') valorizationScore += 2;
      else if (r(42) === 'depends') valorizationScore += 1;

      // AXE 3: BIEN-ÃŠTRE
      let wellbeingScore = 0;
      if (r(1) === 'good') wellbeingScore += 3;
      else if (r(1) === 'okay') wellbeingScore += 2;
      else if (r(1) === 'lost') wellbeingScore += 1;
      
      if (r(9) === 'energetic') wellbeingScore += 3;
      else if (r(9) === 'variable') wellbeingScore += 2;
      else if (r(9) === 'tired') wellbeingScore += 1;
      
      if (r(20) === 'good') wellbeingScore += 3;
      else if (r(20) === 'okay') wellbeingScore += 2;
      else if (r(20) === 'tired') wellbeingScore += 1;
      
      if (r(21) === 'well') wellbeingScore += 2;
      else if (r(21) === 'variable') wellbeingScore += 1;
      
      if (r(22) === 'yes') wellbeingScore += 2;
      else if (r(22) === 'unbalanced') wellbeingScore += 1;
      
      if (r(23) === 'yes_helpful') wellbeingScore += 2;
      else if (r(23) === 'interested') wellbeingScore += 1;
      
      if (r(24) === 'rarely') wellbeingScore += 3;
      else if (r(24) === 'sometimes') wellbeingScore += 2;
      else if (r(24) === 'often') wellbeingScore += 1;
      
      if (r(27) === 'hours') wellbeingScore += 2;
      else if (r(27) === 'one_hour') wellbeingScore += 1;
      
      if (['little','moderate'].includes(r(28))) wellbeingScore += 2;
      else if (r(28) === 'much') wellbeingScore += 1;
      
      if (r(29) === 'no') wellbeingScore += 2;
      else if (r(29) === 'occasional') wellbeingScore += 1;

      // AXE 4: RESSOURCES
      let resourcesScore = 0;
      if (r(8) === 'own_place') resourcesScore += 3;
      else if (r(8) === 'family') resourcesScore += 2;
      else if (r(8) === 'friend') resourcesScore += 1;
      
      if (r(7) === 'manage_well') resourcesScore += 3;
      else if (r(7) === 'manage_tight') resourcesScore += 2;
      else if (r(7) === 'struggle') resourcesScore += 1;
      
      if (r(25) === 'yes_vehicle') resourcesScore += 3;
      else if (r(25) === 'yes_no_vehicle') resourcesScore += 2;
      else if (r(25) === 'in_progress') resourcesScore += 1;
      
      if (r(26) === 'car') resourcesScore += 2;
      else if (['public','bike_walk'].includes(r(26))) resourcesScore += 1;
      
      if (r(16) === 'comfortable') resourcesScore += 2;
      else if (r(16) === 'phone_only') resourcesScore += 1;

      const lifeSkills = [
        { emoji: 'ğŸ§ ', label: 'PersonnalitÃ©', value: Math.min(5, Math.round((personalityScore / 22) * 5)), description: 'Confiance, motivation, autonomie' },
        { emoji: 'â­', label: 'Valorisation', value: Math.min(5, Math.round((valorizationScore / 21) * 5)), description: 'CompÃ©tences, expÃ©riences, savoirs' },
        { emoji: 'ğŸ’š', label: 'Bien-Ãªtre', value: Math.min(5, Math.round((wellbeingScore / 21) * 5)), description: 'SantÃ© physique et mentale' },
        { emoji: 'ğŸ ', label: 'Ressources', value: Math.min(5, Math.round((resourcesScore / 11) * 5)), description: 'Logement, finances, mobilitÃ©' }
      ];

      const thematicSkills = [
        { emoji: 'ğŸ’¼', label: 'Emploi', value: calculateSkill([11,12,44,16,36,5,43]), description: 'Chercher et dÃ©crocher un emploi' },
        { emoji: 'ğŸ“š', label: 'Formation', value: calculateSkill([33,34,35,17,31,32,14,15]), description: 'Se former et apprendre' },
        { emoji: 'ğŸš—', label: 'MobilitÃ©', value: calculateSkill([25,26,18,19,36]), description: 'Se dÃ©placer et Ãªtre mobile' },
        { emoji: 'ğŸ§­', label: 'Orientation', value: calculateSkill([14,40,49,42,50]), description: 'Clarifier son projet' },
        { emoji: 'ğŸ’°', label: 'Budget', value: calculateSkill([7,22,2,32]), description: 'GÃ©rer son argent' },
        { emoji: 'ğŸ’»', label: 'NumÃ©rique', value: calculateSkill([16,27,36,28]), description: 'MaÃ®triser les outils digitaux' },
        { emoji: 'ğŸ¥', label: 'SantÃ©', value: calculateSkill([20,21,22,24,23,29]), description: 'Prendre soin de soi' },
        { emoji: 'ğŸ ', label: 'Logement', value: calculateSkill([8,2]), description: 'Avoir un lieu stable' }
      ];

      const improvements = lifeSkills.filter(s => s.value <= 2).map(s => ({
          emoji: s.emoji, title: s.label, description: s.description
      }));
      if(improvements.length === 0) improvements.push({ emoji: 'â­', title: 'Top niveau !', description: 'Tu gÃ¨res sur tous les plans.' });

      const avgLifeSkills = lifeSkills.reduce((a,b)=>a+b.value,0)/4;
      let result = { title: "ğŸ“ En Transition", subtitle: "Un parcours adaptÃ© Ã  ton rythme", parcours: [] };

      if (avgLifeSkills < 2.5 || lifeSkills[2].value <= 2 || r(13) === 'health') {
          result = {
              title: "ğŸ¤ Besoin d'Accompagnement",
              subtitle: "On avance ensemble, pas Ã  pas",
              parcours: [
                  { emoji: 'ğŸ’ª', title: 'Confiance en soi', description: 'Ateliers pour retrouver l\'estime de soi', tags: ['Bien-Ãªtre'], link: '#' },
                  { emoji: 'ğŸ§˜', title: 'Gestion du stress', description: 'Techniques pour gÃ©rer l\'anxiÃ©tÃ©', tags: ['SantÃ©'], link: '#' },
                  { emoji: 'ğŸ‘¥', title: 'Ateliers collectifs', description: 'Rencontrer d\'autres jeunes', tags: ['Social'], link: '#' }
              ]
          };
      } else if (thematicSkills[3].value <= 2 || r(14) === 'no_idea') {
          result = {
              title: "ğŸ—ºï¸ En DÃ©couverte",
              subtitle: "Explorer pour trouver ta voie",
              parcours: [
                  { emoji: 'ğŸ”', title: 'DÃ©couverte mÃ©tiers', description: 'Explorer les secteurs qui recrutent', tags: ['Orientation'], link: '#' },
                  { emoji: 'ğŸ§­', title: 'Bilan compÃ©tences', description: 'Savoir ce que tu aimes faire', tags: ['Bilan'], link: '#' }
              ]
          };
      } else if (lifeSkills[0].value >= 4) {
           result = {
              title: "ğŸš€ PrÃªt Ã  dÃ©coller",
              subtitle: "Tu as tout pour rÃ©ussir !",
              parcours: [
                  { emoji: 'ğŸ¯', title: 'Projet Pro', description: 'ConcrÃ©tiser ton plan d\'action', tags: ['Projet'], link: '#' },
                  { emoji: 'ğŸ’¡', title: 'Entrepreneuriat', description: 'CrÃ©er ton activitÃ©', tags: ['Business'], link: '#' }
              ]
          };
      } else {
          result.parcours = [
            { emoji: 'ğŸ¯', title: 'Construire son parcours', description: 'Structurer ton projet Ã©tape par Ã©tape', tags: ['Orientation'], link: 'https://mlpb-tools.my.canva.site/mini-parcours-th-matiques' },
            { emoji: 'ğŸš€', title: 'Vers l\'emploi', description: 'CV, lettre et entretiens', tags: ['Emploi'], link: 'https://mlpb-tools.my.canva.site/mini-parcours-th-matiques' }
          ];
      }

      return {
          ...result,
          lifeSkills,
          thematicSkills: thematicSkills.sort((a,b) => b.value - a.value).slice(0, 4),
          improvements
      };
    }

    function calculateSkill(questionIds) {
        let score = 0;
        let max = questionIds.length * 3;
        questionIds.forEach(id => {
             const ans = responses[id];
             if(ans && (ans.includes('yes') || ans.includes('good') || ans.includes('well') || ans.includes('fluent'))) score += 3;
             else if(ans && (ans.includes('sometimes') || ans.includes('okay'))) score += 2;
             else score += 1;
        });
        return Math.min(5, Math.max(1, Math.round((score/max)*5) + 1));
    }

    function fireConfetti(big = false) {
        try {
            const canvas = document.getElementById('confettiCanvas');
            if (!canvas) {
                console.warn('R.P.E: Confetti canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('R.P.E: Could not get canvas context');
                return;
            }
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const particleCount = big ? 150 : 30;

            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * (big ? 20 : 10),
                    vy: (Math.random() - 0.5) * (big ? 20 : 10),
                    color: ['#8A2BE2', '#FF007F', '#D32F2F', '#FFD93D'][Math.floor(Math.random() * 4)],
                    size: Math.random() * 8 + 2,
                    life: 100
                });
            }

            function animate() {
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let active = false;
                    particles.forEach(p => {
                        if (p.life > 0) {
                            active = true;
                            p.x += p.vx;
                            p.y += p.vy;
                            p.vy += 0.2;
                            p.life--;
                            ctx.fillStyle = p.color;
                            ctx.fillRect(p.x, p.y, p.size, p.size);
                        }
                    });
                    if (active) requestAnimationFrame(animate);
                    else ctx.clearRect(0, 0, canvas.width, canvas.height);
                } catch (error) {
                    console.warn('R.P.E: Confetti animation error', error);
                }
            }
            animate();
            
            console.log(`R.P.E: Confetti launched (${particleCount} particles)`);
            
        } catch (error) {
            console.error('R.P.E: Confetti initialization error', error);
        }
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostic Life Skills - Mission Locale</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <style>
    :root {
      /* Palette Mission Locale Pays Basque */
      --mlpb-orange: #f39200;
      --mlpb-green: #95c11f;
      --mlpb-blue: #2897d5;
      --mlpb-pink: #d60b52;
      --mlpb-violet: #a3195b;
      --mlpb-brick: #9f3d3f;
      --mlpb-black: #171718;

      --bg-main: #ffffff;
      --bg-soft: #f7fafc;
      --border-soft: #e2e8f0;
      --text-main: #111827;
      --text-muted: #4b5563;
      --text-light: #6b7280;
      --shadow-soft: 0 8px 20px rgba(15, 23, 42, 0.06);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --focus-ring: 0 0 0 3px rgba(40, 151, 213, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: "Poppins", "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    body {
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 24px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 24px 28px 20px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border-bottom: 3px solid var(--mlpb-blue);
      background: linear-gradient(90deg, #ffffff 0%, #f3f7fb 50%, #ffffff 100%);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .logo-left,
    .logo-container {
      background: #ffffff;
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      max-height: 56px;
    }

    .logo-left img,
    .logo-container img {
      max-height: 44px;
      width: auto;
      object-fit: contain;
    }

    .header-text h1 {
      margin: 0 0 4px 0;
      font-size: 1.7rem;
      font-weight: 800;
      color: var(--mlpb-violet);
      letter-spacing: 0.03em;
    }

    .header-text p {
      margin: 0;
      font-size: 0.95rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(40, 151, 213, 0.06);
      border: 1px solid rgba(40, 151, 213, 0.2);
      font-size: 0.75rem;
      color: var(--mlpb-blue);
      font-weight: 600;
    }

    .content {
      padding: 28px;
      background: #ffffff;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .intro-section {
      margin-bottom: 24px;
    }

    .intro-title-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
    }

    .intro-section h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--mlpb-pink);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .intro-section h2 span.icon {
      font-size: 1.6rem;
    }

    .intro-section p {
      margin: 12px 0 0 0;
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 720px;
      line-height: 1.6;
    }

    .intro-context {
      margin-top: 14px;
      padding: 14px 16px;
      background: var(--bg-soft);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--mlpb-orange);
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .intro-context strong {
      color: var(--mlpb-orange);
    }

    .info-panel {
      margin: 22px 0;
      padding: 18px 18px 16px 18px;
      border-radius: var(--radius-lg);
      background: #ffffff;
      border: 1px solid var(--border-soft);
      display: grid;
      grid-template-columns: 1.3fr 1.2fr;
      gap: 12px;
    }

    .info-panel h3 {
      margin: 0 0 8px 0;
      font-size: 0.98rem;
      font-weight: 700;
      color: var(--mlpb-violet);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .info-panel p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .legend-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .legend-item {
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: #ffffff;
    }

    .legend-item small {
      opacity: 0.9;
    }

    .legend-1 { background: var(--mlpb-brick); }
    .legend-2 { background: var(--mlpb-orange); }
    .legend-3 { background: var(--mlpb-green); }
    .legend-4 { background: var(--mlpb-blue); }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .form-group small {
      display: block;
      font-size: 0.78rem;
      color: var(--text-light);
    }

    .form-group input {
      width: 100%;
      padding: 11px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .form-group input:focus-visible {
      outline: none;
      border-color: var(--mlpb-blue);
      box-shadow: var(--focus-ring);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 11px 20px;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--mlpb-blue);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(40, 151, 213, 0.3);
    }

    .btn-primary:hover {
      background: #1d7cb1;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(40, 151, 213, 0.35);
    }

    .btn-secondary {
      background: #ffffff;
      color: var(--text-main);
      border: 1px solid var(--border-soft);
    }

    .btn-secondary:hover {
      background: var(--bg-soft);
    }

    .btn-ghost {
      background: transparent;
      color: var(--mlpb-blue);
      border: 1px solid transparent;
    }

    .btn-ghost:hover {
      background: rgba(40, 151, 213, 0.06);
      border-color: rgba(40, 151, 213, 0.15);
    }

    .btn-danger {
      background: var(--mlpb-brick);
      color: #ffffff;
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .saved-assessments {
      margin-top: 16px;
      padding: 14px 16px;
      border-radius: var(--radius-lg);
      background: #f0f9ff;
      border: 1px solid #bfdbfe;
    }

    .saved-assessments h3 {
      margin: 0 0 8px 0;
      font-size: 0.95rem;
      color: var(--mlpb-blue);
    }

    .assessment-item {
      background: #ffffff;
      border-radius: var(--radius-md);
      padding: 10px 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border: 1px solid var(--border-soft);
    }

    .assessment-info {
      font-size: 0.85rem;
    }

    .assessment-name {
      font-weight: 600;
      color: var(--text-main);
    }

    .assessment-date {
      color: var(--text-light);
      font-size: 0.8rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #edf2f7;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--mlpb-pink), var(--mlpb-orange), var(--mlpb-green), var(--mlpb-blue));
      transition: width 0.35s ease;
    }

    .domain-section {
      background: #ffffff;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      padding: 18px 18px 16px 18px;
      margin-bottom: 18px;
    }

    .domain-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .domain-title {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--mlpb-violet);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .domain-icon {
      font-size: 1.3rem;
    }

    .domain-chip {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 4px 9px;
      background: rgba(40, 151, 213, 0.06);
      color: var(--mlpb-blue);
      border: 1px solid rgba(40, 151, 213, 0.2);
    }

    .domain-objective {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px dashed var(--border-soft);
    }

    .question {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid #f3f4f6;
    }

    .question-text-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .question-text {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-main);
    }

    .question-tooltip {
      font-size: 0.8rem;
      color: var(--text-light);
      cursor: help;
    }

    .rating-scale {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .rating-option {
      border-radius: var(--radius-md);
      padding: 9px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      border: 1px solid transparent;
      cursor: pointer;
      background: #f9fafb;
      transition: transform 0.08s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .rating-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .rating-label-main {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .rating-label-sub {
      font-size: 0.75rem;
      color: var(--text-light);
    }

    .rating-option[data-value="1"] {
      background: #fef2f2;
      border-color: #fee2e2;
    }

    .rating-option[data-value="2"] {
      background: #fff7ed;
      border-color: #ffedd5;
    }

    .rating-option[data-value="3"] {
      background: #ecfdf3;
      border-color: #bbf7d0;
    }

    .rating-option[data-value="4"] {
      background: #eff6ff;
      border-color: #bfdbfe;
    }

    .rating-option:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.06);
    }

    .rating-option.selected[data-value="1"] {
      background: var(--mlpb-brick);
      border-color: var(--mlpb-brick);
      color: #ffffff;
    }

    .rating-option.selected[data-value="2"] {
      background: var(--mlpb-orange);
      border-color: var(--mlpb-orange);
      color: #111827;
    }

    .rating-option.selected[data-value="3"] {
      background: var(--mlpb-green);
      border-color: var(--mlpb-green);
      color: #064e3b;
    }

    .rating-option.selected[data-value="4"] {
      background: var(--mlpb-blue);
      border-color: var(--mlpb-blue);
      color: #ffffff;
    }

    .rating-option.selected .rating-label-main,
    .rating-option.selected .rating-label-sub {
      color: inherit;
    }

    .nav-row {
      text-align: center;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .results-section h2 {
      margin: 0 0 8px 0;
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--mlpb-violet);
      text-align: left;
    }

    .results-section p {
      margin: 4px 0 14px 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .radar-container {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      margin-top: 10px;
    }

    .chart-container {
      background: #ffffff;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      padding: 16px 16px 12px 16px;
    }

    .chart-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--mlpb-violet);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chart-title span.icon {
      font-size: 1.1rem;
    }

    .life-skills-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .skill-card {
      background: var(--bg-soft);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .skill-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .skill-score {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--mlpb-blue);
    }

    .domain-bars {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }

    .domain-bar {
      border-radius: var(--radius-md);
      padding: 8px 8px 6px 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .domain-bar-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .bar-container {
      width: 100%;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      height: 18px;
    }

    .bar-fill {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: #ffffff;
      background: linear-gradient(90deg, var(--mlpb-pink), var(--mlpb-orange));
      transition: width 0.4s ease;
    }

    .priority-areas,
    .action-plan {
      margin-top: 16px;
      border-radius: var(--radius-lg);
      padding: 16px 16px 14px 16px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
    }

    .priority-title,
    .action-title {
      margin: 0 0 8px 0;
      font-size: 0.98rem;
      font-weight: 700;
      color: var(--mlpb-violet);
    }

    .priority-areas p,
    .action-plan p {
      font-size: 0.88rem;
      color: var(--text-muted);
      margin: 3px 0;
    }

    .priority-areas label {
      font-size: 0.85rem;
    }

    .selected-priorities {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--mlpb-blue);
      font-weight: 600;
    }

    .results-actions {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
    }

    .loading {
      display: none;
      margin-top: 16px;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .spinner {
      border: 3px solid #e5e7eb;
      border-top: 3px solid var(--mlpb-blue);
      border-radius: 50%;
      width: 28px;
      height: 28px;
      margin: 0 auto 6px auto;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .activity-card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 16px 16px 14px 16px;
      margin-top: 14px;
      border: 1px solid var(--border-soft);
    }

    .activity-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .activity-icon {
      font-size: 1.4rem;
    }

    .activity-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-main);
    }

    .activity-subtitle {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .activity-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
    }

    .meta-item {
      font-size: 0.78rem;
      padding: 5px 9px;
      border-radius: 999px;
      background: var(--bg-soft);
      color: var(--text-light);
    }

    .skills-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0;
    }

    .skill-tag {
      font-size: 0.78rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(163, 25, 91, 0.08);
      color: var(--mlpb-violet);
    }

    .activity-steps h4 {
      margin: 8px 0 4px 0;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .step-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .step-item {
      font-size: 0.85rem;
      background: #f9fafb;
      border-radius: var(--radius-md);
      padding: 7px 9px;
      margin-top: 5px;
    }

    .transfer-note {
      margin-top: 8px;
      padding: 8px 9px;
      border-radius: var(--radius-md);
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      font-size: 0.83rem;
      color: #166534;
    }

    .transfer-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .inline-message {
      position: fixed;
      z-index: 2000;
      right: 20px;
      top: 20px;
      max-width: 320px;
      border-radius: var(--radius-md);
      padding: 10px 12px;
      font-size: 0.9rem;
      color: #ffffff;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      animation: fadeInSlide 0.25s ease-out;
    }

    .inline-message span.icon {
      font-size: 1.1rem;
      margin-top: 1px;
    }

    .inline-message.success { background: #16a34a; }
    .inline-message.error { background: #b91c1c; }
    .inline-message.warning { background: #f59e0b; }

    @keyframes fadeInSlide {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Export JSON panel */
    #exportPanel {
      margin-top: 12px;
      display: none;
    }

    #exportPanel textarea {
      width: 100%;
      min-height: 140px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      padding: 8px;
      resize: vertical;
      background: #f9fafb;
    }

    #exportPanel small {
      display: block;
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--text-light);
    }

    /* Print / PDF */
    @media print {
      body {
        padding: 0;
        background: #ffffff;
      }

      .container {
        box-shadow: none;
        border-radius: 0;
        border: none;
      }

      .btn,
      .inline-message,
      .saved-assessments,
      .nav-row,
      .results-actions {
        display: none !important;
      }

      #exportPanel {
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      body { padding: 10px; }

      .container { border-radius: 16px; }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-left {
        width: 100%;
        justify-content: space-between;
      }

      .info-panel {
        grid-template-columns: 1fr;
      }

      .legend-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .content { padding: 18px 16px 20px 16px; }

      .life-skills-grid {
        grid-template-columns: 1fr;
      }

      .radar-container {
        grid-template-columns: 1fr;
      }

      .rating-scale {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .inline-message {
        right: 10px;
        left: 10px;
        top: 10px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <div class="container" role="main" aria-label="Outil de diagnostic Life Skills Mission Locale">
    <div class="header">
      <div class="header-left">
        <div class="logo-left" aria-label="Logo Mission Locale Pays Basque">
          <img
            src="https://static.wixstatic.com/media/dd5dab_47743b1c86024865ba19e623a3db327f~mv2.avif/v1/fill/w_313,h_84,al_c,lg_1,q_80,enc_avif,quality_auto/dd5dab_47743b1c86024865ba19e623a3db327f~mv2.avif"
            alt="Mission Locale Pays Basque"
            onerror="this.src=''; this.alt='Logo Mission Locale indisponible'; this.style.display='none';">
        </div>
        <div class="header-text">
          <h1 id="toolTitle">Diagnostic Life Skills</h1>
          <p id="organizationName">
            Mission Locale Pays Basque ‚Ä¢ Parcours d'accompagnement ancr√© Life Skills
          </p>
          <div class="header-badge" aria-hidden="true">
            <span>üîé</span> Socle RPE / 11 domaines d'insertion
          </div>
        </div>
      </div>
      <div class="logo-container" aria-label="Logo LS4YOU">
        <img
          src="https://static.wixstatic.com/media/dd5dab_31e98305be67485d92cdb56f82c0e03f~mv2.png/v1/fill/w_560,h_224,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/LS4YOU_Logo.png"
          alt="LS4YOU - Life Skills for Youth"
          onerror="this.src=''; this.alt='Logo LS4YOU indisponible'; this.style.display='none';">
      </div>
    </div>

    <div class="content">

      <!-- √âtape 1: Accueil -->
      <div class="step active" id="step-welcome">
        <section class="intro-section" aria-labelledby="intro-title">
          <div class="intro-title-row">
            <div>
              <h2 id="intro-title"><span class="icon">üéØ</span>Diagnostic Life Skills ‚Äì 11 domaines d'insertion</h2>
              <p id="instructionsText">
                Ce diagnostic vous permettra d'identifier vos forces et vos besoins dans 11 domaines essentiels √† votre
                insertion sociale et professionnelle. Il sert de base commune de dialogue entre le jeune et le conseiller.
              </p>
              <div class="intro-context" aria-label="Contexte d'utilisation">
                <strong>Rep√®re RPE :</strong> ce questionnaire est un outil d'appui au premier accueil, √† l'entretien
                d'accompagnement et √† la construction du parcours. Il ne remplace pas l'√©change, il l'organise
                autour des Life Skills (personnalit√©, valorisation, bien-√™tre, ressources).
              </div>
            </div>
          </div>

          <div class="info-panel" aria-label="Mode d'emploi du diagnostic">
            <div>
              <h3>Comment r√©pondre ?</h3>
              <p>
                Pour chaque affirmation, choisissez le niveau qui vous ressemble le plus aujourd'hui.
                Il n'y a pas de bonne ou de mauvaise r√©ponse : l'objectif est d'avoir une photographie r√©aliste.
              </p>
            </div>
            <div>
              <h3>L√©gende des niveaux</h3>
              <div class="legend-grid">
                <div class="legend-item legend-1">
                  <span>üî¥ Zone de d√©fi</span>
                  <small>C'est difficile pour moi</small>
                </div>
                <div class="legend-item legend-2">
                  <span>üü° En progression</span>
                  <small>J'y arrive parfois</small>
                </div>
                <div class="legend-item legend-3">
                  <span>üü¢ Plut√¥t au point</span>
                  <small>Je me d√©brouille bien</small>
                </div>
                <div class="legend-item legend-4">
                  <span>‚≠ê C'est mon fort</span>
                  <small>Je ma√Ætrise vraiment</small>
                </div>
              </div>
            </div>
          </div>
        </section>

        <div class="form-group">
          <label for="participantName">Pr√©nom et nom du jeune *</label>
          <input type="text" id="participantName" required aria-required="true"
                 placeholder="Ex : Marie Dupont">
          <small>Ces informations figureront uniquement sur la synth√®se du diagnostic.</small>
        </div>

        <div id="lastAssessmentBanner" class="saved-assessments" style="display:none;" aria-label="Dernier diagnostic enregistr√©">
          <h3>üóÇ Reprendre le dernier diagnostic local</h3>
          <div class="assessment-item">
            <div class="assessment-info">
              <div class="assessment-name" id="lastAssessmentName"></div>
              <div class="assessment-date" id="lastAssessmentDate"></div>
            </div>
            <button class="btn btn-secondary btn-small"
                    type="button"
                    onclick="StorageManager.loadLastAssessment()"
                    aria-label="Recharger le dernier diagnostic sauvegard√© sur cet appareil">
              Recharger
            </button>
          </div>
        </div>

        <div class="saved-assessments" id="savedAssessments" style="display:none;" aria-label="Diagnostics sauvegard√©s dans la base">
          <h3>üìã Diagnostics pr√©c√©dents (base de donn√©es)</h3>
          <div id="assessmentsList"></div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary"
                  type="button"
                  onclick="startAssessment()"
                  aria-label="Commencer le diagnostic Life Skills">
            Commencer le diagnostic
          </button>
          <button class="btn btn-ghost"
                  type="button"
                  onclick="showInlineMessage('Le diagnostic peut √™tre utilis√© en autonomie, en entretien ou en atelier collectif. Le conseiller choisit le mode adapt√©.', 'warning')">
            ‚ÑπÔ∏è Rappel modes d'usage (autonomie / entretien / collectif)
          </button>
        </div>
      </div>

      <!-- √âtape 2: Questions -->
      <div class="step" id="step-assessment" aria-label="Questions par domaine Life Skills">
        <div class="progress-bar" aria-hidden="true">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="questionsContainer"></div>

        <div class="nav-row">
          <button class="btn btn-secondary"
                  type="button"
                  id="prevBtn"
                  style="display:none;"
                  onclick="previousDomain()"
                  aria-label="Revenir au domaine pr√©c√©dent">
            ‚¨ÖÔ∏è Pr√©c√©dent
          </button>
          <button class="btn btn-primary"
                  type="button"
                  id="nextBtn"
                  onclick="nextDomain()"
                  aria-label="Passer au domaine suivant">
            Suivant ‚û°Ô∏è
          </button>
        </div>
      </div>

      <!-- √âtape 3: R√©sultats -->
      <div class="step" id="step-results" aria-label="Synth√®se des r√©sultats Life Skills">
        <div class="results-section">
          <h2>üìä Vos r√©sultats Life Skills</h2>
          <p>
            Cette synth√®se met en lien les 11 domaines d‚Äôinsertion avec les 4 axes Life Skills.
            Elle sert de support au debrief avec le jeune et √† la construction du mini-parcours.
          </p>

          <div class="radar-container">
            <div class="chart-container" aria-label="Scores par axe Life Skills">
              <div class="chart-title"><span class="icon">üß†</span>Comp√©tences Life Skills</div>
              <div class="life-skills-grid" id="lifeSkillsResults"></div>
            </div>

            <div class="chart-container" aria-label="Scores par domaine d'insertion">
              <div class="chart-title"><span class="icon">üìà</span>Domaines d'insertion</div>
              <div class="domain-bars" id="domainResults"></div>
            </div>
          </div>

          <div class="priority-areas" id="priorityAreas"></div>

          <div class="action-plan" id="actionPlan"></div>

          <div class="results-actions">
            <button class="btn btn-secondary"
                    type="button"
                    onclick="restartAssessment()">
              Nouveau diagnostic
            </button>
            <button class="btn btn-primary"
                    type="button"
                    id="saveBtn"
                    onclick="saveResults()">
              üíæ Sauvegarder (base de donn√©es)
            </button>
            <button class="btn btn-secondary"
                    type="button"
                    onclick="StorageManager.saveToLocal()">
              üíª Sauvegarder en local
            </button>
            <button class="btn btn-secondary"
                    type="button"
                    onclick="exportToJSON()">
              üì§ Export JSON
            </button>
            <button class="btn btn-secondary"
                    type="button"
                    onclick="window.print()">
              üñ®Ô∏è Export PDF
            </button>
            <button class="btn btn-primary"
                    type="button"
                    style="background: var(--mlpb-green);"
                    onclick="showActivities()">
              üéØ Voir les activit√©s propos√©es
            </button>
          </div>

          <div id="exportPanel" aria-label="Export des donn√©es au format JSON">
            <textarea id="exportData" readonly></textarea>
            <small>
              Copiez/collez ces donn√©es dans votre SI ou dans un outil de suivi (interop√©rabilit√©).
            </small>
          </div>

          <div class="loading" id="loading">
            <div class="spinner" role="status" aria-label="Chargement"></div>
            <p>Sauvegarde en cours...</p>
          </div>
        </div>
      </div>

      <!-- √âtape 4: Activit√©s -->
      <div class="step" id="step-activities" aria-label="Activit√©s recommand√©es par domaine">
        <div class="results-section">
          <h2>üéØ Activit√©s adapt√©es √† vos besoins</h2>
          <p>
            Ces activit√©s LS4YOU peuvent √™tre mobilis√©es en atelier collectif, en entretien ou en autonomie,
            pour travailler les comp√©tences identifi√©es comme prioritaires.
          </p>

          <div id="activitiesContainer"></div>

          <div class="results-actions" style="margin-top: 16px;">
            <button class="btn btn-secondary"
                    type="button"
                    onclick="showStep('step-results')">
              ‚¨ÖÔ∏è Retour √† la synth√®se
            </button>
            <button class="btn btn-secondary"
                    type="button"
                    onclick="restartAssessment()">
              Nouveau diagnostic
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // --- CONFIG DOMAINES & QUESTIONS (inchang√© sur le fond) ---

    const domains = [
      {
        name: "Emploi",
        icon: "üíº",
        objective: "√âvaluer la capacit√© √† se pr√©senter, comprendre les codes professionnels, demander de l'aide, se projeter dans le travail",
        questions: [
          "M√™me sans dipl√¥me, je sais mettre en avant mes qualit√©s",
          "Face √† un employeur, j'arrive √† expliquer pourquoi il devrait me recruter",
          "Quand on me donne une mission, je comprends ce qu'on attend de moi",
          "Si j'ai des difficult√©s au travail, j'ose demander de l'aide",
          "Il y a au moins un type de m√©tier o√π je me projette"
        ],
        lifeSkills: {
          "Personnalit√©": "motivation / choix / forces",
          "Valorisation": "parler de soi / pitch",
          "Bien-√™tre": "stress entretien, pression",
          "Ressources": "salaire / contrats"
        }
      },
      {
        name: "Formation",
        icon: "üìö",
        objective: "√âvaluer concentration, pers√©v√©rance, rapport √† l'erreur, capacit√© √† poser des questions",
        questions: [
          "M√™me si l'√©cole √©tait difficile, je peux me concentrer sur ce qui m'int√©resse",
          "Je peux suivre une formation sur plusieurs jours sans abandonner",
          "En cours, j'ose poser des questions si je ne comprends pas",
          "Les examens me stressent mais ne me paralysent pas",
          "Si une formation peut m'aider, je suis pr√™t¬∑e √† faire des efforts"
        ],
        lifeSkills: {
          "Personnalit√©": "pers√©v√©rance / rapport √† l'effort",
          "Valorisation": "reconnaissance des progr√®s",
          "Bien-√™tre": "charge mentale / stress scolaire",
          "Ressources": "aides formation"
        }
      },
      {
        name: "Orientation",
        icon: "üß≠",
        objective: "√âvaluer int√©r√™ts, valeurs, forces, id√©es d'avenir, flexibilit√©",
        questions: [
          "J'ai au moins une id√©e de ce que je pourrais faire plus tard",
          "Je sais ce qui me pla√Æt dans la vie, m√™me si ce n'est pas scolaire",
          "Il y a des domaines o√π je me d√©brouille mieux que d'autres",
          "J'ai le droit de me tromper et de changer de voie",
          "M√™me dans l'incertitude, je vois quelques pistes pour avancer"
        ],
        lifeSkills: {
          "Personnalit√©": "int√©r√™ts / valeurs",
          "Valorisation": "confiance / identit√©",
          "Bien-√™tre": "anxi√©t√© orientation",
          "Ressources": "r√©alit√©s m√©tiers / contraintes"
        }
      },
      {
        name: "Mobilit√©",
        icon: "üöó",
        objective: "Observer organisation, autonomie, acc√®s aux transports, gestion stress d√©placements",
        questions: [
          "Quand j'ai un rendez-vous important, j'arrive √† m'y rendre",
          "J'ai au moins un moyen de me d√©placer (m√™me si c'est compliqu√©)",
          "Si je dois aller quelque part de nouveau, je peux demander comment faire",
          "Parfois les transports me posent des probl√®mes (argent, stress, organisation)",
          "Je sais vers qui me tourner si j'ai un probl√®me de transport"
        ],
        lifeSkills: {
          "Personnalit√©": "autonomie",
          "Valorisation": "fiabilit√© (√™tre √† l'heure)",
          "Bien-√™tre": "anxi√©t√© trajets",
          "Ressources": "permis / co√ªt / r√©seau"
        }
      },
      {
        name: "Sant√©",
        icon: "‚ù§Ô∏è",
        objective: "√âvaluer √©nergie, stress, strat√©gies de r√©gulation, rep√©rage des signaux",
        questions: [
          "En g√©n√©ral, j'ai l'√©nergie pour faire ce que j'ai √† faire",
          "Je sens quand √ßa ne va pas dans ma t√™te ou mon corps",
          "J'ai ma fa√ßon √† moi de d√©compresser quand √ßa va mal",
          "Il y a au moins une personne √† qui je peux dire que √ßa ne va pas",
          "Ma sant√© (physique ou mentale) me complique parfois les choses"
        ],
        lifeSkills: {
          "Personnalit√©": "limites personnelles",
          "Valorisation": "se sentir digne de soin",
          "Bien-√™tre": "c≈ìur du domaine",
          "Ressources": "acc√®s aux soins"
        }
      },
      {
        name: "Logement",
        icon: "üè°",
        objective: "Comprendre l'impact du logement sur le quotidien, la s√©curit√©, la capacit√© √† avancer",
        questions: [
          "J'ai un endroit o√π dormir en s√©curit√©",
          "Chez moi, je peux me reposer tranquillement quand j'en ai besoin",
          "Mon logement me permet d'aller √† mes rendez-vous et activit√©s",
          "Si ma situation de logement changeait, je saurais qui contacter"
        ],
        lifeSkills: {
          "Personnalit√©": "estime ‚Äì je m√©rite un lieu stable",
          "Valorisation": "capacit√© √† demander un accompagnement",
          "Bien-√™tre": "sommeil / s√©curit√©",
          "Ressources": "logement / dispositifs"
        }
      },
      {
        name: "Citoyennet√©",
        icon: "üî¥",
        objective: "√âvaluer l'expression, la participation, la capacit√© √† demander du soutien",
        questions: [
          "Dans un petit groupe bienveillant, j'arrive √† dire ce que je pense",
          "Il y a au moins un adulte qui m'√©coute vraiment",
          "Je sais que j'ai des droits, m√™me si je ne connais pas tout",
          "S'il y avait un projet qui m'int√©resse, je pourrais m'y investir"
        ],
        lifeSkills: {
          "Personnalit√©": "sentiment d'agir",
          "Valorisation": "place dans les groupes",
          "Bien-√™tre": "environnement sain ou toxique",
          "Ressources": "droits / participation"
        }
      },
      {
        name: "Finances",
        icon: "üí∂",
        objective: "Explorer compr√©hension du budget, aides, stress financier",
        questions: [
          "Je sais combien j'ai d'argent par mois (m√™me si ce n'est pas beaucoup)",
          "Je vois quand je vais avoir des difficult√©s financi√®res",
          "Je peux parler d'argent avec quelqu'un sans avoir honte",
          "Je sais qu'il y a des aides possibles (m√™me si je ne connais pas tout)",
          "Le manque d'argent m'emp√™che parfois de faire certaines choses"
        ],
        lifeSkills: {
          "Personnalit√©": "prise de d√©cision / priorisation",
          "Valorisation": "sortir de la honte financi√®re",
          "Bien-√™tre": "stress budget",
          "Ressources": "aides / gestion"
        }
      },
      {
        name: "Loisirs",
        icon: "üé®",
        objective: "Rep√©rer activit√©s qui soutiennent l'√©quilibre et la motivation",
        questions: [
          "J'ai au moins une activit√© que j'aime faire qui me fait du bien",
          "Je prends du temps pour moi dans la semaine",
          "De temps en temps, je teste de nouvelles activit√©s ou endroits",
          "Mes activit√©s m'aident √† aller mieux ou √† avoir confiance",
          "Je vois un lien entre ce que j'aime et ce que je pourrais faire plus tard"
        ],
        lifeSkills: {
          "Personnalit√©": "go√ªts, talents",
          "Valorisation": "parler de ses passions comme forces",
          "Bien-√™tre": "r√©gulation √©motionnelle",
          "Ressources": "acc√®s activit√©"
        }
      },
      {
        name: "Num√©rique",
        icon: "üì±",
        objective: "√âvaluer acc√®s aux outils, comp√©tences num√©riques essentielles, s√©curit√© en ligne",
        questions: [
          "J'ai acc√®s √† un t√©l√©phone et internet quand j'en ai besoin",
          "Je peux me d√©brouiller pour faire des d√©marches en ligne",
          "Je sais chercher des informations utiles sur internet",
          "Je fais attention √† ce que je poste sur les r√©seaux sociaux",
          "Si j'ai des difficult√©s avec le num√©rique, je sais √† qui demander"
        ],
        lifeSkills: {
          "Personnalit√©": "limites / choix / contr√¥le",
          "Valorisation": "pr√©sence en ligne pro",
          "Bien-√™tre": "gestion r√©seaux / pression sociale",
          "Ressources": "acc√®s num√©rique / d√©marches"
        }
      },
      {
        name: "Mode de vie",
        icon: "‚è≥",
        objective: "Comprendre comment le rythme quotidien impacte projet, √©nergie et disponibilit√©",
        questions: [
          "Mes horaires de sommeil me permettent de tenir le coup",
          "Quand c'est important, j'arrive √† √™tre √† l'heure",
          "Je note mes rendez-vous importants pour ne pas les oublier",
          "J'arrive √† jongler entre mes diff√©rentes activit√©s",
          "Je sais quand j'ai besoin de faire une pause et je le fais"
        ],
        lifeSkills: {
          "Personnalit√©": "organisation personnelle / limites",
          "Valorisation": "fiabilit√© / ponctualit√©",
          "Bien-√™tre": "√©quilibre vie / r√©cup√©ration",
          "Ressources": "gestion du temps / outils"
        }
      }
    ];

    const lifeSkillsMapping = {
      "Personnalit√©": ["Orientation", "Sant√©", "Mode de vie"],
      "Valorisation": ["Emploi", "Formation", "Citoyennet√©"],
      "Bien-√™tre": ["Sant√©", "Logement", "Loisirs"],
      "Ressources": ["Mobilit√©", "Finances", "Num√©rique"]
    };

    // Activit√©s (inchang√© sur le fond ‚Äì m√™me liste que ta version pr√©c√©dente)
    const domainActivities = {
      "Emploi": [
        {
          title: "Mon Pitch en 30 secondes",
          objective: "Apprendre √† parler de soi simplement",
          skills: ["Valorisation", "Personnalit√©"],
          duration: "45 min",
          format: "Individuel + vid√©o",
          steps: [
            "Compl√©ter 3 phrases : 'Je suis...', 'On me reconna√Æt souvent pour...', 'Je suis dou√©¬∑e pour...'",
            "Construire un pitch simple et authentique",
            "Enregistrer une vid√©o de pr√©sentation",
            "Recevoir des retours bienveillants du groupe"
          ],
          transfer: "Utile pour les entretiens d'embauche et pr√©sentations professionnelles"
        }
      ],
      "Formation": [
        {
          title: "Le Feedback qui fait grandir",
          objective: "Apprendre √† recevoir et demander un feedback",
          skills: ["Valorisation", "Bien-√™tre"],
          duration: "1h",
          format: "Collectif + bin√¥mes",
          steps: [
            "Mini-jeu : identifier 'bon feedback / mauvais feedback'",
            "Simulations en bin√¥me pour pratiquer",
            "√âlaboration d'une action 'je progresse dans...'",
            "Debrief collectif sur les apprentissages"
          ],
          transfer: "Am√©liore la capacit√© d'apprentissage et l'adaptation en formation"
        }
      ],
      "Orientation": [
        {
          title: "Mon Mini Magazine de Vie (Zine)",
          objective: "Faire √©merger centres d'int√©r√™t et valeurs",
          skills: ["Personnalit√©", "Valorisation"],
          duration: "1h30",
          format: "Cr√©atif individuel",
          steps: [
            "D√©couper/coller des images refl√©tant la vie souhait√©e",
            "Structurer en 4 pages : moi / mes forces / ce que j'aime / o√π je veux aller",
            "Finaliser son magazine personnel",
            "Pr√©sentation optionnelle au groupe"
          ],
          transfer: "Clarifie le projet de vie et facilite les choix d'orientation"
        }
      ],
      "Mobilit√©": [
        {
          title: "Moi en D√©placement : choix & cons√©quences",
          objective: "Comprendre l'impact de la mobilit√©",
          skills: ["Ressources", "Organisation"],
          duration: "45 min",
          format: "Simulation pratique",
          steps: [
            "Choisir un sc√©nario : 'aller au travail', 'aller en formation', 'aller voir quelqu'un important'",
            "Identifier les solutions possibles de transport",
            "Calculer le co√ªt de chaque solution",
            "Analyser les difficult√©s potentielles",
            "D√©finir sa prochaine √©tape mobilit√© concr√®te"
          ],
          transfer: "Facilite l'acc√®s √† l'emploi et √† la formation en anticipant les contraintes"
        }
      ],
      "Sant√©": [
        {
          title: "Mon Stressom√®tre",
          objective: "Rep√©rer signes de stress + cr√©er un plan d'apaisement",
          skills: ["Bien-√™tre", "Personnalit√©"],
          duration: "1h",
          format: "Auto-√©valuation + cr√©ation d'outils",
          steps: [
            "Auto-√©valuation de son niveau de stress actuel",
            "Identifier son profil : zen / pressur√© / en alerte",
            "Rep√©rer ses signaux personnels de stress",
            "√âlaborer son 'kit apaisement' personnalis√©",
            "Tester une technique d'apaisement imm√©diatement"
          ],
          transfer: "Am√©liore la performance en entretien et la gestion du quotidien"
        }
      ],
      "Logement": [
        {
          title: "Mon Budget Logement",
          objective: "Visualiser le co√ªt de la vie autonome",
          skills: ["Ressources"],
          duration: "45 min",
          format: "Calcul pratique",
          steps: [
            "Rechercher et calculer le co√ªt d'un logement r√©el dans sa zone",
            "Lister toutes les charges associ√©es (√©lectricit√©, internet, assurance...)",
            "Comparer le co√ªt total avec ses ressources actuelles/futures",
            "Identifier les ajustements possibles (colocation, aides, zone g√©ographique)",
            "D√©finir un plan d'action logement r√©aliste"
          ],
          transfer: "Pr√©pare l'autonomie et s√©curise les conditions de vie pour l'insertion"
        }
      ],
      "Citoyennet√©": [
        {
          title: "Ma Carte de Soutien",
          objective: "Identifier son r√©seau d'aide",
          skills: ["Valorisation", "Personnalit√©"],
          duration: "1h",
          format: "Cartographie + action",
          steps: [
            "Dessiner son r√©seau actuel (famille, amis, professionnels, institutions)",
            "Ajouter les personnes positives et ressources",
            "Identifier ses besoins d'aide actuels et futurs",
            "Rep√©rer les manques dans son r√©seau",
            "Action concr√®te : contacter 1 personne ressource cette semaine"
          ],
          transfer: "Facilite l'acc√®s aux opportunit√©s et au soutien dans l'insertion"
        }
      ],
      "Finances": [
        {
          title: "Du Brut au Net",
          objective: "Comprendre salaire + g√©rer budget",
          skills: ["Ressources"],
          duration: "1h",
          format: "Simulation + planification",
          steps: [
            "Simuler un salaire net √† partir d'un salaire brut (charges sociales, imp√¥ts)",
            "Lister toutes les d√©penses essentielles mensuelles",
            "Calculer le reste √† vivre apr√®s les charges obligatoires",
            "Construire un budget √©quilibr√© et r√©aliste",
            "Identifier les marges de man≈ìuvre et d'√©pargne"
          ],
          transfer: "Pr√©pare √† la n√©gociation salariale et √† l'autonomie financi√®re"
        }
      ],
      "Loisirs": [
        {
          title: "Mes Boosters de Bien-√ätre",
          objective: "Identifier activit√©s qui donnent de l'√©nergie",
          skills: ["Bien-√™tre"],
          duration: "30 min",
          format: "R√©flexion + planification",
          steps: [
            "Lister 'Ce qui me fait du bien' (activit√©s, lieux, personnes)",
            "S√©lectionner 3 activit√©s faciles √† mettre en place",
            "V√©rifier la faisabilit√© (co√ªt, temps, accessibilit√©)",
            "Inscrire ces activit√©s dans un planning hebdomadaire",
            "S'engager sur une premi√®re action dans les 48h"
          ],
          transfer: "Am√©liore l'√©quilibre vie pro/perso et maintient la motivation"
        }
      ],
      "Num√©rique": [
        {
          title: "Mon Image en Ligne",
          objective: "Ma√Ætriser identit√© num√©rique",
          skills: ["Valorisation", "Ressources"],
          duration: "1h",
          format: "Audit + cr√©ation",
          steps: [
            "Google test : rechercher son nom et voir ce qui appara√Æt",
            "Audit de ses profils sur les r√©seaux sociaux",
            "Nettoyage rapide (photos inappropri√©es, statuts probl√©matiques)",
            "Cr√©ation ou am√©lioration d'un profil professionnel simple",
            "D√©finir sa strat√©gie de pr√©sence en ligne"
          ],
          transfer: "√âvite les √©cueils en recrutement et valorise son profil professionnel"
        }
      ],
      "Mode de vie": [
        {
          title: "Ma Routine Qui Me Fait du Bien",
          objective: "Cr√©er un mode de vie stable",
          skills: ["Personnalit√©", "Bien-√™tre"],
          duration: "45 min",
          format: "Analyse + construction",
          steps: [
            "Identifier ses habitudes actuelles positives et n√©gatives",
            "Choisir 1 changement utile et r√©alisable",
            "Construire un plan quotidien simple et stable",
            "D√©finir des indicateurs de r√©ussite",
            "Pr√©voir les obstacles et solutions de contournement"
          ],
          transfer: "Am√©liore la r√©gularit√© et l'efficacit√© dans les d√©marches d'insertion"
        }
      ]
    };

    let currentDomain = 0;
    let responses = {};
    let currentRecordCount = 0;
    let allAssessments = [];

    const defaultConfig = {
      tool_title: "Diagnostic Life Skills",
      organization_name: "Mission Locale Edition",
      instructions_text: "Ce diagnostic vous permettra d'identifier vos forces et vos besoins dans 11 domaines essentiels √† votre insertion sociale et professionnelle."
    };

    const dataHandler = {
      onDataChanged(data) {
        allAssessments = data;
        currentRecordCount = data.length;
        displaySavedAssessments();
      }
    };

    // --- GESTION LOCALSTORAGE ---

    const StorageManager = {
      key: "ls4you_diag_v1",

      getStored() {
        try {
          const raw = localStorage.getItem(this.key);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          console.error("Erreur lecture localStorage", e);
          return null;
        }
      },

      showBannerIfAny() {
        const data = this.getStored();
        if (!data) return;

        const banner = document.getElementById('lastAssessmentBanner');
        const nameEl = document.getElementById('lastAssessmentName');
        const dateEl = document.getElementById('lastAssessmentDate');

        banner.style.display = 'block';
        nameEl.textContent = data.participant_name || "Jeune non nomm√©";
        dateEl.textContent = data.assessment_date
          ? "Diagnostic local du " + new Date(data.assessment_date).toLocaleString('fr-FR')
          : "";
      },

      saveToLocal() {
        try {
          const participantName = document.getElementById('participantName').value.trim();
          if (!participantName) {
            showInlineMessage("Renseignez le nom du jeune avant de sauvegarder en local.", "warning");
            return;
          }

          const { domainScores, lifeSkillsScores } = computeScores();
          const payload = {
            participant_name: participantName,
            assessment_date: new Date().toISOString(),
            responses,
            domain_scores: domainScores,
            life_skills_scores: lifeSkillsScores
          };

          localStorage.setItem(this.key, JSON.stringify(payload));
          this.showBannerIfAny();
          showInlineMessage("Diagnostic sauvegard√© sur cet appareil (localStorage).", "success");
        } catch (e) {
          console.error(e);
          showInlineMessage("Impossible de sauvegarder en local (navigateur).", "error");
        }
      },

      loadLastAssessment() {
        const data = this.getStored();
        if (!data) {
          showInlineMessage("Aucun diagnostic local trouv√©.", "warning");
          return;
        }
        try {
          document.getElementById('participantName').value = data.participant_name || "";
          responses = data.responses || {};
          showResults();
          showStep('step-results');
          showInlineMessage("Dernier diagnostic local recharg√©.", "success");
        } catch (e) {
          console.error(e);
          showInlineMessage("Erreur lors du rechargement du diagnostic local.", "error");
        }
      }
    };

    // --- INITIALISATION ---

    async function initializeApp() {
      try {
        if (window.dataSdk) {
          const initResult = await window.dataSdk.init(dataHandler);
          if (!initResult.isOk) {
            console.error("Erreur d'initialisation du SDK de donn√©es");
          }
        }

        if (window.elementSdk) {
          await window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
              const toolTitle = config.tool_title || defaultConfig.tool_title;
              const orgName = config.organization_name || defaultConfig.organization_name;
              const instructions = config.instructions_text || defaultConfig.instructions_text;

              document.getElementById('toolTitle').textContent = toolTitle;
              document.getElementById('organizationName').textContent = orgName;
              document.getElementById('instructionsText').textContent = instructions;
            },
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.primary_color || "#2897d5",
                  set: (value) => {
                    if (window.elementSdk) {
                      window.elementSdk.setConfig({ primary_color: value });
                    }
                  }
                },
                {
                  get: () => config.secondary_color || "#f39200",
                  set: (value) => {
                    if (window.elementSdk) {
                      window.elementSdk.setConfig({ secondary_color: value });
                    }
                  }
                }
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || "Poppins",
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ font_family: value });
                  }
                }
              },
              fontSizeable: {
                get: () => config.font_size || 16,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ font_size: value });
                  }
                }
              }
            }),
            mapToEditPanelValues: (config) => new Map([
              ["tool_title", config.tool_title || defaultConfig.tool_title],
              ["organization_name", config.organization_name || defaultConfig.organization_name],
              ["instructions_text", config.instructions_text || defaultConfig.instructions_text]
            ])
          });
        }
      } catch (e) {
        console.error("Erreur d'initialisation globale", e);
      }

      StorageManager.showBannerIfAny();
    }

    // --- AFFICHAGE DES DIAGNOSTICS SAUVEGARDES (BACKEND) ---

    function displaySavedAssessments() {
      const container = document.getElementById('savedAssessments');
      const list = document.getElementById('assessmentsList');

      if (!allAssessments || allAssessments.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      list.innerHTML = '';

      allAssessments.forEach(assessment => {
        const item = document.createElement('div');
        item.className = 'assessment-item';

        const date = new Date(assessment.assessment_date);
        const formattedDate = date.toLocaleDateString('fr-FR') + " " + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

        item.innerHTML = `
          <div class="assessment-info">
            <div class="assessment-name">${assessment.participant_name}</div>
            <div class="assessment-date">Diagnostic du ${formattedDate}</div>
          </div>
          <button class="btn btn-secondary btn-small" type="button"
                  onclick="viewAssessment('${assessment.__backendId}')">
            Voir la synth√®se
          </button>
        `;

        list.appendChild(item);
      });
    }

    function viewAssessment(assessmentId) {
      const assessment = allAssessments.find(a => a.__backendId === assessmentId);
      if (!assessment) return;

      try {
        responses = JSON.parse(assessment.domain_scores) || {};
      } catch {
        responses = {};
      }

      showResults();
      showStep('step-results');
    }

    // --- PARCOURS QUESTIONNAIRE ---

    function startAssessment() {
      const name = document.getElementById('participantName').value.trim();
      if (!name) {
        showInlineMessage("Veuillez saisir le pr√©nom et nom du jeune pour commencer.", "warning");
        return;
      }

      currentDomain = 0;
      responses = {};
      generateQuestions();
      showStep('step-assessment');
      updateProgress();
      updateNavigationButtons();
    }

    function generateQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';

      domains.forEach((domain, domainIndex) => {
        const domainDiv = document.createElement('section');
        domainDiv.className = 'domain-section';
        domainDiv.id = `domain-${domainIndex}`;
        domainDiv.style.display = domainIndex === 0 ? 'block' : 'none';
        domainDiv.setAttribute('aria-label', `Domaine ${domain.name}`);

        const questionCount = domain.questions.length;

        domainDiv.innerHTML = `
          <div class="domain-header-row">
            <div class="domain-title">
              <span class="domain-icon">${domain.icon}</span>
              ${domain.name}
            </div>
            <div class="domain-chip">${questionCount} question(s)</div>
          </div>
          <p class="domain-objective"><strong>Objectif :</strong> ${domain.objective}</p>
        `;

        domain.questions.forEach((question, questionIndex) => {
          const questionId = `q_${domainIndex}_${questionIndex}`;
          const questionDiv = document.createElement('div');
          questionDiv.className = 'question';

          questionDiv.innerHTML = `
            <div class="question-text-row">
              <div class="question-text">
                ${question}
              </div>
              <div class="question-tooltip" title="R√©pondez en fonction de votre situation actuelle, pas de ce que vous pensez devoir r√©pondre.">
                ‚ùì
              </div>
            </div>
            <div class="rating-scale" role="radiogroup"
                 aria-label="√âchelle de 1 √† 4 pour la question : ${question}">
              ${[1,2,3,4].map(value => {
                const { main, sub } = getRatingLabelsDetailed(value);
                return `
                  <label class="rating-option"
                         data-value="${value}"
                         onclick="selectRating('${questionId}', ${value}, this)"
                         aria-label="${main} - ${sub}">
                    <input type="radio" name="${questionId}" value="${value}">
                    <span class="rating-label-main">${main}</span>
                    <span class="rating-label-sub">${sub}</span>
                  </label>
                `;
              }).join('')}
            </div>
          `;
          domainDiv.appendChild(questionDiv);
        });

        container.appendChild(domainDiv);
      });
    }

    function getRatingLabelsDetailed(value) {
      if (value === 1) return { main: "üî¥ Zone de d√©fi", sub: "C'est difficile pour moi" };
      if (value === 2) return { main: "üü° En progression", sub: "J'y arrive parfois" };
      if (value === 3) return { main: "üü¢ Plut√¥t au point", sub: "Je me d√©brouille bien" };
      return { main: "‚≠ê C'est mon fort", sub: "Je ma√Ætrise vraiment" };
    }

    function selectRating(questionId, value, labelEl) {
      responses[questionId] = value;

      const group = labelEl.parentElement;
      Array.from(group.children).forEach(child => child.classList.remove('selected'));
      labelEl.classList.add('selected');

      updateNavigationButtons();
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      prevBtn.style.display = currentDomain > 0 ? 'inline-flex' : 'none';

      if (currentDomain === domains.length - 1) {
        const allAnswered = domainFullyAnswered(currentDomain);
        nextBtn.textContent = 'Voir la synth√®se';
        nextBtn.disabled = !allAnswered;
      } else {
        nextBtn.textContent = 'Suivant ‚û°Ô∏è';
        nextBtn.disabled = false;
      }
    }

    function domainFullyAnswered(domainIndex) {
      return domains[domainIndex].questions.every((_, qIndex) =>
        responses[`q_${domainIndex}_${qIndex}`] !== undefined
      );
    }

    function nextDomain() {
      if (!domainFullyAnswered(currentDomain)) {
        showInlineMessage("R√©pondez √† toutes les questions du domaine avant de continuer.", "warning");
        return;
      }

      if (currentDomain < domains.length - 1) {
        document.getElementById(`domain-${currentDomain}`).style.display = 'none';
        currentDomain++;
        document.getElementById(`domain-${currentDomain}`).style.display = 'block';
        updateProgress();
        updateNavigationButtons();
      } else {
        showResults();
        showStep('step-results');
      }
    }

    function previousDomain() {
      if (currentDomain > 0) {
        document.getElementById(`domain-${currentDomain}`).style.display = 'none';
        currentDomain--;
        document.getElementById(`domain-${currentDomain}`).style.display = 'block';
        updateProgress();
        updateNavigationButtons();
      }
    }

    function updateProgress() {
      const progress = ((currentDomain + 1) / domains.length) * 100;
      document.getElementById('progressFill').style.width = `${progress}%`;
    }

    // --- CALCUL SCORES & AFFICHAGE ---

    function computeScores() {
      const domainScores = {};
      domains.forEach((domain, domainIndex) => {
        const domainResponses = domain.questions.map((_, qIndex) =>
          responses[`q_${domainIndex}_${qIndex}`] || 0
        );
        const average = domainResponses.reduce((a, b) => a + b, 0) / domainResponses.length;
        domainScores[domain.name] = Math.round((average / 4) * 100);
      });

      const lifeSkillsScores = {};
      Object.keys(lifeSkillsMapping).forEach(skill => {
        const relatedDomains = lifeSkillsMapping[skill];
        const scores = relatedDomains.map(domainName => domainScores[domainName] ?? 0);
        const average = scores.reduce((a, b) => a + b, 0) / scores.length;
        lifeSkillsScores[skill] = Math.round(average);
      });

      return { domainScores, lifeSkillsScores };
    }

    function showResults() {
      const { domainScores, lifeSkillsScores } = computeScores();

      displayLifeSkillsResults(lifeSkillsScores);
      displayDomainResults(domainScores);
      displayPriorityAreas(domainScores);
      displayActionPlan(domainScores);
    }

    function displayLifeSkillsResults(scores) {
      const container = document.getElementById('lifeSkillsResults');
      container.innerHTML = '';

      Object.entries(scores).forEach(([skill, score]) => {
        const card = document.createElement('div');
        card.className = 'skill-card';
        card.innerHTML = `
          <div class="skill-name">${skill}</div>
          <div class="skill-score">${score}%</div>
        `;
        container.appendChild(card);
      });
    }

    function displayDomainResults(scores) {
      const container = document.getElementById('domainResults');
      container.innerHTML = '';

      Object.entries(scores).forEach(([domain, score]) => {
        const bar = document.createElement('div');
        bar.className = 'domain-bar';

        const color = score < 40
          ? 'linear-gradient(90deg, #b91c1c, #ef4444)'
          : score < 60
            ? 'linear-gradient(90deg, #f97316, #facc15)'
            : score < 80
              ? 'linear-gradient(90deg, #22c55e, #4ade80)'
              : 'linear-gradient(90deg, #2563eb, #38bdf8)';

        bar.innerHTML = `
          <div class="domain-bar-name">${domain}</div>
          <div class="bar-container">
            <div class="bar-fill" style="width:${score}%; background:${color};">
              ${score}%
            </div>
          </div>
        `;
        container.appendChild(bar);
      });
    }

    function displayPriorityAreas(scores) {
      const lowScoreAreas = Object.entries(scores)
        .filter(([_, score]) => score < 60)
        .sort((a, b) => a[1] - b[1])
        .map(([domain, score]) => ({ domain, score }));

      const container = document.getElementById('priorityAreas');

      if (lowScoreAreas.length === 0) {
        container.innerHTML = `
          <div class="priority-title">üéâ Aucun domaine en alerte</div>
          <p>Vous avez des scores satisfaisants dans tous les domaines. Le conseiller peut cibler 1 √† 2 domaines √† renforcer en fonction du projet.</p>
        `;
      } else {
        container.innerHTML = `
          <div class="priority-title">üéØ S√©lection des 1 √† 3 domaines prioritaires</div>
          <p>Choisissez avec le jeune les domaines √† travailler en priorit√© :</p>
          <div style="margin-top: 6px;">
            ${lowScoreAreas.map(({domain, score}) => `
              <label style="display:block; margin:4px 0; padding:6px 8px; border-radius:10px; background:#ffffff; border:1px solid #e5e7eb; cursor:pointer;">
                <input type="checkbox" name="priority" value="${domain}"
                       style="margin-right:8px;"
                       onchange="updatePrioritySelection()">
                <strong>${domain}</strong> ‚Äì ${score}%
              </label>
            `).join('')}
          </div>
          <div id="selectedPriorities" class="selected-priorities"></div>
        `;
      }
    }

    function updatePrioritySelection() {
      const checkboxes = document.querySelectorAll('input[name="priority"]:checked');
      const selected = Array.from(checkboxes).map(cb => cb.value);
      const display = document.getElementById('selectedPriorities');

      if (selected.length > 3) {
        checkboxes[checkboxes.length - 1].checked = false;
        selected.pop();
      }

      if (selected.length > 0) {
        display.textContent = "‚úÖ Domaines retenus : " + selected.join(", ");
      } else {
        display.textContent = "";
      }
    }

    function generateRecommendations(scores) {
      const lowScores = Object.entries(scores)
        .filter(([_, score]) => score < 60)
        .sort((a, b) => a[1] - b[1]);

      if (lowScores.length === 0) {
        return `
          <p><strong>Maintien et d√©veloppement :</strong></p>
          <ul>
            <li>Capitaliser sur les points forts du jeune (mentorat, tutorat, projets).</li>
            <li>Identifier 1 √† 2 domaines √† consolider en lien avec le projet professionnel.</li>
            <li>Programmer des points d'√©tape r√©guliers pour ajuster le parcours.</li>
          </ul>
        `;
      }

      const recommandations = {
        "Emploi": "Ateliers CV / lettre, simulation entretien, appui √† la p√©riode d'essai.",
        "Formation": "Bilan de pr√©requis, accompagnement aux d√©marches de formation, s√©curisation du rythme.",
        "Orientation": "Travail sur les int√©r√™ts / valeurs, immersion, rencontres m√©tiers.",
        "Mobilit√©": "Diagnostic mobilit√©, solutions alternatives (covoiturage, pr√™t solidaire), appui permis.",
        "Sant√©": "Lien vers les partenaires sant√©, outils de gestion du stress, am√©nagements si besoin.",
        "Logement": "Orientation vers les dispositifs logement, accompagnement administratif, pr√©vention ruptures.",
        "Citoyennet√©": "Mobilisation sur des projets collectifs, valorisation des engagements, travail sur les droits.",
        "Finances": "Ateliers budget, m√©diation si dettes, rep√©rage des aides mobilisables.",
        "Loisirs": "Mise en lien avec des structures locales, valorisation des centres d'int√©r√™t.",
        "Num√©rique": "Appui aux d√©marches en ligne, ateliers comp√©tences num√©riques de base.",
        "Mode de vie": "Travail sur les routines, les priorit√©s, le sommeil et la gestion de l'√©nergie."
      };

      return `
        <p><strong>Axes d'action conseill√©s :</strong></p>
        <ol>
          ${lowScores.slice(0, 3).map(([domain, _]) =>
            `<li><strong>${domain}</strong> : ${recommandations[domain] || "√Ä pr√©ciser avec le conseiller."}</li>`
          ).join('')}
        </ol>
        <p><em>√Ä formaliser dans le mini-parcours (autonomie / entretiens / ateliers collectifs LS4YOU).</em></p>
      `;
    }

    function displayActionPlan(scores) {
      const container = document.getElementById('actionPlan');
      const recommendations = generateRecommendations(scores);
      container.innerHTML = `
        <div class="action-title">üìã Pistes pour le mini-parcours d'accompagnement</div>
        ${recommendations}
      `;
    }

    // --- SAUVEGARDE BACKEND ---

    async function saveResults() {
      if (currentRecordCount >= 999) {
        showInlineMessage("Limite de 999 diagnostics atteinte. Supprimez d'anciens diagnostics si besoin.", "error");
        return;
      }

      const saveBtn = document.getElementById('saveBtn');
      const loading = document.getElementById('loading');

      saveBtn.disabled = true;
      loading.style.display = 'block';

      try {
        const participantName = document.getElementById('participantName').value.trim();
        if (!participantName) {
          showInlineMessage("Nom du jeune manquant. Retournez √† l'√©tape 1 si n√©cessaire.", "warning");
          saveBtn.disabled = false;
          loading.style.display = 'none';
          return;
        }

        const { domainScores, lifeSkillsScores } = computeScores();

        const priorityAreas = Object.entries(domainScores)
          .filter(([_, score]) => score < 60)
          .map(([domain]) => domain);

        const assessmentData = {
          participant_name: participantName,
          assessment_date: new Date().toISOString(),
          domain_scores: JSON.stringify(domainScores),
          life_skills_scores: JSON.stringify(lifeSkillsScores),
          priority_areas: JSON.stringify(priorityAreas),
          action_plan: generateRecommendations(domainScores),
          completed: true
        };

        if (window.dataSdk) {
          const result = await window.dataSdk.create(assessmentData);
          if (result.isOk) {
            showInlineMessage("Diagnostic sauvegard√© dans la base de donn√©es.", "success");
          } else {
            showInlineMessage("Erreur lors de la sauvegarde en base. V√©rifiez la connexion.", "error");
          }
        } else {
          showInlineMessage("SDK de donn√©es non disponible. Impossible de sauvegarder en base.", "error");
        }
      } catch (error) {
        console.error(error);
        showInlineMessage("Erreur inattendue lors de la sauvegarde.", "error");
      } finally {
        saveBtn.disabled = false;
        loading.style.display = 'none';
      }
    }

    function restartAssessment() {
      currentDomain = 0;
      responses = {};
      showStep('step-welcome');
      updateProgress();
    }

    function showStep(stepId) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.getElementById(stepId).classList.add('active');
    }

    function showInlineMessage(message, type) {
      const div = document.createElement('div');
      div.className = `inline-message ${type}`;
      const icon = type === 'success' ? '‚úÖ'
        : type === 'error' ? '‚ö†Ô∏è'
        : '‚ÑπÔ∏è';
      div.innerHTML = `<span class="icon">${icon}</span><span>${message}</span>`;
      document.body.appendChild(div);

      setTimeout(() => {
        div.style.opacity = '0';
        setTimeout(() => {
          if (div.parentNode) div.parentNode.removeChild(div);
        }, 250);
      }, 3500);
    }

    // --- ACTIVIT√âS ---

    function showActivities() {
      const { domainScores } = computeScores();

      const priorityDomains = Object.entries(domainScores)
        .filter(([_, score]) => score < 60)
        .sort((a, b) => a[1] - b[1])
        .map(([domain]) => domain);

      const domainsToShow = priorityDomains.length > 0
        ? priorityDomains.slice(0, 3)
        : Object.entries(domainScores)
            .sort((a, b) => a[1] - b[1])
            .slice(0, 3)
            .map(([domain]) => domain);

      displayActivities(domainsToShow, domainScores);
      showStep('step-activities');
    }

    function displayActivities(priorityDomains, domainScores) {
      const container = document.getElementById('activitiesContainer');
      container.innerHTML = '';

      if (!priorityDomains || priorityDomains.length === 0) {
        container.innerHTML = `
          <div class="activity-card">
            <h3>üéâ Aucun domaine prioritaire clairement identifi√©</h3>
            <p>Le diagnostic n'a pas fait ressortir de domaines en difficult√©. Le conseiller peut s√©lectionner 1 √† 2 activit√©s LS4YOU en lien avec le projet du jeune.</p>
          </div>
        `;
        return;
      }

      const intro = document.createElement('div');
      intro.className = 'activity-card';
      intro.innerHTML = `
        <h3>üß© Proposition de mini-parcours LS4YOU</h3>
        <p>Domaines en priorit√© (scores les plus bas) :</p>
        <div class="activity-meta">
          ${priorityDomains.map(domain =>
            `<span class="meta-item">${domain} ‚Äì ${domainScores[domain]}%</span>`
          ).join('')}
        </div>
        <p style="font-size:0.85rem; color:#4b5563;">
          Ces activit√©s peuvent √™tre combin√©es : 1 s√©ance individuelle d'appui + 1 atelier collectif LS4YOU.
        </p>
      `;
      container.appendChild(intro);

      priorityDomains.forEach(domainName => {
        const activities = domainActivities[domainName];
        if (!activities) return;

        activities.forEach(activity => {
          const card = document.createElement('div');
          card.className = 'activity-card';

          const domainIcon = domains.find(d => d.name === domainName)?.icon || 'üéØ';

          card.innerHTML = `
            <div class="activity-header">
              <div class="activity-icon">${domainIcon}</div>
              <div>
                <h3 class="activity-title">${activity.title}</h3>
                <p class="activity-subtitle">Domaine : ${domainName}</p>
              </div>
            </div>

            <p style="font-size:0.88rem; color:#374151;"><strong>Objectif :</strong> ${activity.objective}</p>

            <div class="skills-tags">
              ${activity.skills.map(skill => `<span class="skill-tag">Life Skill : ${skill}</span>`).join('')}
            </div>

            <div class="activity-meta">
              <div class="meta-item">‚è±Ô∏è ${activity.duration}</div>
              <div class="meta-item">üë• ${activity.format}</div>
            </div>

            <div class="activity-steps">
              <h4>üìã D√©roul√© p√©dagogique (collectif ou individuel) :</h4>
              <ul class="step-list">
                ${activity.steps.map(step => `<li class="step-item">${step}</li>`).join('')}
              </ul>
            </div>

            <div class="transfer-note">
              <div class="transfer-title">üîÑ Transfert dans le parcours Mission Locale :</div>
              <p>${activity.transfer}</p>
            </div>
          `;

          container.appendChild(card);
        });
      });

      const finalNote = document.createElement('div');
      finalNote.className = 'activity-card';
      finalNote.innerHTML = `
        <h4 style="margin:0 0 4px 0;">üí° Pour le conseiller</h4>
        <p style="font-size:0.86rem; color:#4b5563;">
          Notez dans le suivi quel(s) format(s) ont √©t√© retenus : autonomie guid√©e (niveau 1),
          entretien (niveau 2), atelier collectif LS4YOU (niveau 3).
        </p>
      `;
      container.appendChild(finalNote);
    }

    // --- EXPORT JSON ---

    function exportToJSON() {
      try {
        const participantName = document.getElementById('participantName').value.trim();
        if (!participantName) {
          showInlineMessage("Renseignez le nom du jeune avant l'export.", "warning");
          return;
        }

        const { domainScores, lifeSkillsScores } = computeScores();
        const payload = {
          participant_name: participantName,
          assessment_date: new Date().toISOString(),
          domain_scores: domainScores,
          life_skills_scores: lifeSkillsScores,
          responses
        };

        const panel = document.getElementById('exportPanel');
        const textarea = document.getElementById('exportData');
        textarea.value = JSON.stringify(payload, null, 2);
        panel.style.display = 'block';
        showInlineMessage("Export JSON g√©n√©r√©. Vous pouvez le copier dans votre SI.", "success");
      } catch (e) {
        console.error(e);
        showInlineMessage("Impossible de g√©n√©rer l'export JSON.", "error");
      }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>

</body>
</html>
